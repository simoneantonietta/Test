#include <alsa/asoundlib.h>

#define PERIOD_SIZE 256
static snd_pcm_t *audio_handle_tx = NULL;
static snd_pcm_t *audio_handle_rx = NULL;

enum {CID_ST_WAIT_HS, CID_ST_HS_1400, CID_ST_HS_MUTE_1, CID_ST_HS_2300, CID_ST_HS_MUTE_2,
      CID_ST_TRANSMIT, CID_ST_WAIT_ACK, CID_ST_ACK};
static volatile int contactid_sm;
static volatile int contactid_sm_count;
static volatile int contactid_idx;
static int contactid_retry;

/* Coefficienti validi per campionamento 8000Hz e buffer di 80 campioni */
#define COEFF_1400 0.907981038094
#define COEFF_2300 -0.466890782118
#define THR 100000000.0
#define NCTONE 410

static const short dtmf_0[] = {
10920,15032,10536,1664,-4960,-5696,-2296,176,-1696,-6504,
-9096,-5232,4256,13488,15816,9096,-2472,-11448,-12704,-7024,
72,3208,1432,-1432,-688,4624,10512,11176,4144,-7088,
-15320,-14984,-6448,4328,10440,9184,3616,-576,-160,3056,
4136,-184,-8104,-13696,-11696,-2040,9528,15640,12728,3592,
-5040,-7920,-5016,-920,-328,-3752,-7112,-5464,2208,11480,
15552,10720,-496,-10992,-14344,-9504,-1176,4336,4192,872,
-584,2536,7944,10144,5304,-4912,-14112,-15816,-8568,2848,
11056,11576,5928,-248,-2176,200,2616,696,-5656,-11744,
-11752,-3864,7680,15488,14488,5760,-4416,-9560,-7768,-2640,
360,-1168,-4632,-4952,528,9144,14544,11784,1568,-9856,
-15288,-11848,-2952,4728,6624,3520,232,928,5216,8424,
5832,-2792,-12328,-15904,-10392,976,10912,13488,8416,752,
-3584,-2624,512,896,-3432,-9328,-11048,-5272,5560,14592,
15640,7952,-3160,-10496,-10328,-4824,328,1048,-1848,-3712,
-608,6696,12856,12168,3520,-8192,-15480,-13840,-5056,4392,
8536,6296,1720,-40,2544,6144,5640,-944,-10120,-15232,
-11728,-1072,10064,14760,10872,2344,-4296,-5224,-2016,360,
-1608,-6656,-9624,-6080,3400,13056,16072,9944,-1432,-10688,
-12488,-7288,-408,2728,1016,-1832,-1096,4368,10640,11808,
5128,-6176,-14920,-15288,-7280,3384,9792,8976,3744,-312,
152,3472,4704,424,-7720,-13840,-12432,-3104,8624,15304,
13056,4344,-4264,-7384,-4776,-864,-368,-3944,-7576,-6200,
1424,11032,15744,11528,568,-10144,-14064,-9800,-1776,3736,
3744,544,-864,2368,8064,10696,6208,-4024,-13664,-16064,
-9400,1840,10320,11344,6128,144,-1760,608,3080,1192,
-5328,-11848,-12408,-4880,6744,15080,14776,6560,-3528,-8944,
-7544,-2696,184,-1424,-5048,-5576,-160,8704,14672,12536,
2648,-8952,-14952,-12152,-3640,4008,6120,3240,88,872,
5360,8904,6632,-1952,-11848,-16088,-11200,-72,10088,13208,
8672,1272,-3056,-2200,888,1256,-3184,-9416,-11624,-6208,
4632,14128,15880,8768,-2184,-9792,-10088,-4968,16,704,
-2248,-4232,-1192,6304,12944,12840,4560,-7248,-15072,-14112,
-5808,3560,7952,6048,1688,32,2744,6568,6328,-184,
-9640,-15352,-12488,-2152,9168,14424,11136,2968,-3648,-4744,
-1704,592,-1472,-6760,-10120,-6928,2512,12552,16256,10744,
-400,-9896,-12200,-7488,-840,2272,600,-2264,-1552,4040,
10696,12392,6104,-5224,-14448,-15520,-8064,2464,9120,8720,
3816,-96,432,3872,5280,1088,-7264,-13912,-13120,-4160,
7672,14888,13312,5040,-3496,-6832,-4496,-752,-352,-4096,
-8008,-6944,600,10512,15856,12288,1632,-9272,-13728,-10032,
};

static const short dtmf_1[] = {
11360,14352,8112,-448,-3824,-1064,1936,-712,-8152,-13104,
-9112,2512,13264,15008,7416,-2160,-5968,-3096,464,-1264,
-7544,-11360,-6688,4840,14664,15008,6088,-4280,-8192,-4848,
-456,-1152,-6352,-9288,-4272,6808,15464,14344,4232,-6640,
-10296,-6176,-752,-400,-4688,-7056,-2056,8272,15608,13056,
1976,-9056,-12112,-6936,-384,920,-2704,-4848,-208,9136,
15080,11240,-504,-11336,-13472,-7056,608,2696,-576,-2848,
1120,9336,13936,9040,-3032,-13312,-14256,-6520,2168,4776,
1488,-1240,1856,8872,12280,6616,-5424,-14824,-14400,-5344,
4176,6968,3336,-144,1928,7808,10248,4160,-7488,-15752,
-13872,-3608,6464,9104,4776,328,1352,6248,8008,1856,
-9080,-16032,-12704,-1440,8856,10976,5696,152,176,4320,
5744,-112,-10096,-15640,-10984,992,11168,12440,5984,-664,
-1472,2208,3656,-1608,-10448,-14616,-8840,3520,13208,13352,
5608,-2072,-3472,96,1912,-2512,-10144,-13040,-6432,5960,
14816,13640,4592,-3952,-5640,-1824,648,-2768,-9216,-11056,
-3944,8112,15864,13248,2992,-6160,-7784,-3384,-8,-2368,
-7752,-8824,-1568,9824,16280,12216,920,-8520,-9720,-4448,
-16,-1352,-5888,-6528,512,10976,16024,10600,-1448,-10840,
-11272,-4904,616,176,-3792,-4344,2152,11488,15120,8528,
-3968,-12928,-12312,-4704,1864,2088,-1656,-2472,3232,11336,
13640,6152,-6432,-14632,-12736,-3848,3608,4208,336,-1056,
3664,10536,11712,3648,-8656,-15800,-12496,-2392,5728,6360,
2008,-208,3440,9184,9496,1208,-10480,-16344,-11600,-440,
8040,8344,3216,-8,2584,7392,7168,-976,-11768,-16224,
-10104,1864,10352,9992,3840,-464,1184,5328,4912,-2752,
-12432,-15440,-8120,4352,12488,11160,3816,-1536,-632,3168,
2920,-3992,-12424,-14072,-5784,6832,14272,11720,3136,-3152,
-2704,1104,1352,-4600,-11760,-12216,-3280,9120,15552,11632,
1832,-5168,-4856,-672,328,-4552,-10520,-10024,-792,11040,
16232,10880,0,-7416,-6880,-2024,-56,-3856,-8808,-7672,
1480,12456,16240,9512,-2208,-9720,-8616,-2808,208,-2592,
-6776,-5360,3384,13256,15592,7616,-4656,-11888,-9896,-2968,
1112,-872,-4608,-3256,4776,13392,14328,5336,-7144,-13744,
-10600,-2456,2576,1144,-2488,-1544,5560,12872,12544,2848,
-9480,-15128,-10664,-1320,4472,3280,-600,-352,5680,11752,
10392,328,-11480,-15936,-10064,368,6656,5344,880,224,
5144,10120,8040,-2016,-13016,-16080,-8824,2488,8936,7152,
1832,144,4016,8136,5672,-4040,-13952,-15568,-7040,4880,
11128,8552,2168,-576,2408,5960,3472,-5576,-14240,-14416,
-4832,7352,13048,9400,1840,-1880,456,3792,1624,-6520,
};

static const short dtmf_2[] = {
11768,13272,5448,-1496,-576,3960,2680,-6560,-14960,-12664,
-536,10304,10872,3880,-456,2720,7232,3928,-7184,-15840,
-12896,-992,8384,7872,1928,360,5776,10200,5136,-7336,
-15880,-12432,-1280,6144,4440,-320,928,8408,12696,6184,
-7056,-15080,-11256,-1352,3728,768,-2752,1208,10496,14568,
6984,-6392,-13504,-9408,-1152,1296,-2936,-5216,1216,11936,
15688,7424,-5440,-11256,-6968,-664,-1008,-6488,-7568,984,
12688,16000,7448,-4312,-8472,-4048,88,-3072,-9680,-9656,
568,12736,15456,7000,-3096,-5312,-808,1080,-4776,-12344,
-11336,48,12104,14088,6064,-1904,-1968,2576,2256,-6048,
-14336,-12480,-496,10864,11960,4656,-824,1368,5928,3520,
-6856,-15544,-12992,-984,9128,9184,2816,48,4528,9056,
4784,-7184,-15928,-12808,-1328,7024,5904,640,688,7328,
11776,5928,-7064,-15464,-11912,-1472,4680,2304,-1752,1048,
9640,13920,6848,-6544,-14200,-10320,-1352,2264,-1408,-4256,
1128,11336,15360,7448,-5712,-12216,-8088,-952,-72,-5048,
-6696,960,12368,16008,7648,-4656,-9640,-5336,-264,-2216,
-8408,-8928,600,12688,15816,7384,-3480,-6624,-2192,672,
-4048,-11304,-10808,96,12328,14776,6624,-2296,-3344,1168,
1816,-5480,-13576,-12192,-448,11336,12944,5376,-1200,0,
4576,3088,-6456,-15112,-12968,-960,9800,10408,3680,-264,
3232,7832,4392,-6960,-15832,-13072,-1368,7840,7312,1600,
424,6184,10752,5616,-7008,-15712,-12464,-1576,5600,3824,
-752,864,8688,13152,6656,-6640,-14768,-11136,-1536,3224,
128,-3256,1024,10632,14896,7400,-5928,-13072,-9144,-1216,
856,-3560,-5768,928,11928,15880,7768,-4968,-10728,-6568,
-608,-1344,-7056,-8120,616,12536,16032,7688,-3848,-7880,
-3544,264,-3288,-10160,-10176,144,12440,15328,7120,-2680,
-4696,-232,1376,-4856,-12696,-11792,-392,11696,13808,6048,
-1568,-1376,3192,2640,-6000,-14544,-12832,-936,10384,11544,
4496,-600,1912,6544,3968,-6672,-15600,-13224,-1384,8592,
8656,2536,160,4976,9632,5264,-6888,-15816,-12896,-1656,
6472,5304,248,672,7664,12272,6408,-6680,-15208,-11848,
-1704,4160,1664,-2232,904,9832,14304,7288,-6096,-13808,
-10104,-1472,1800,-2048,-4792,880,11384,15608,7824,-5232,
-11720,-7744,-944,-448,-5640,-7248,624,12264,16104,7928,
-4184,-9064,-4872,-128,-2480,-8920,-9464,184,12448,15752,
7544,-3048,-6016,-1632,920,-4184,-11704,-11288,-336,11968,
14552,6656,-1936,-2744,1776,2168,-5480,-13840,-12584,-896,
10880,12576,5272,-936,560,5200,3520,-6328,-15224,-13248,
-1384,9280,9928,3440,-112,3720,8432,4864,-6712,-15784,
};

static const short dtmf_3[] = {
12112,11744,2848,-808,4280,6920,-1672,-13816,-14992,-3824,
6064,4864,-672,1656,10776,13208,2496,-10680,-12448,-4120,
784,-3616,-7504,-416,12312,15816,5968,-4960,-5320,376,
-568,-9592,-13944,-4928,8952,12864,5416,-576,2904,7816,
2408,-10528,-16256,-8040,3608,5624,40,-360,8240,14312,
7224,-6952,-12960,-6696,192,-2200,-7872,-4240,8528,16296,
9976,-2048,-5736,-552,1136,-6768,-14312,-9328,4744,12712,
7896,360,1536,7696,5872,-6352,-15936,-11720,320,5640,
1128,-1720,5232,13960,11184,-2384,-12120,-8984,-1080,-952,
-7296,-7248,4080,15184,13216,1528,-5312,-1728,2104,-3680,
-13272,-12744,-56,11184,9912,1928,480,6720,8360,-1760,
-14056,-14424,-3464,4736,2304,-2296,2168,12280,13968,2536,
-9920,-10624,-2888,-144,-5992,-9184,-520,12584,15296,5416,
-3928,-2824,2296,-744,-11032,-14824,-4976,8352,11088,3912,
-24,5176,9704,2720,-10816,-15800,-7336,2896,3240,-2128,
-544,9560,15304,7304,-6512,-11272,-4960,32,-4296,-9928,
-4784,8792,15920,9152,-1656,-3520,1808,1680,-7936,-15400,
-9464,4456,11152,5992,120,3400,9864,6640,-6576,-15648,
-10824,232,3640,-1376,-2624,6192,15112,11400,-2224,-10720,
-6960,-456,-2536,-9544,-8264,4224,14976,12280,1328,-3576,
864,3360,-4400,-14456,-13048,-120,9968,7816,944,1744,
8984,9600,-1800,-13936,-13480,-3000,3304,-304,-3872,2616,
13472,14368,2512,-8904,-8512,-1568,-1056,-8224,-10632,-616,
12536,14376,4712,-2824,-248,4176,-888,-12184,-15328,-4896,
7544,9024,2296,496,7296,11344,2976,-10816,-14936,-6432,
2128,776,-4256,-728,10632,15904,7208,-5912,-9296,-3096,
-96,-6264,-11728,-5208,8832,15136,8096,-1224,-1224,4144,
2200,-8880,-16088,-9368,4048,9312,3928,-136,5160,11792,
7256,-6616,-14952,-9640,144,1568,-3864,-3480,6984,15872,
11320,-2008,-9056,-4752,192,-4040,-11544,-9072,4248,14392,
11024,1080,-1768,3440,4544,-4992,-15272,-13016,-168,8504,
5520,-80,2944,11016,10600,-1784,-13456,-12184,-2440,1800,
-2912,-5376,2976,14312,14400,2424,-7664,-6192,-184,-1920,
-10232,-11824,-696,12160,13088,3880,-1656,2320,5952,-984,
-13016,-15440,-4696,6552,6728,600,992,9232,12704,3152,
-10544,-13688,-5352,1320,-1696,-6288,-912,11424,16104,6912,
-5168,-7088,-1136,-208,-8064,-13240,-5504,8640,13960,6816,
-792,1088,6384,2680,-9600,-16368,-9016,3560,7240,1744,
-408,6784,13416,7688,-6496,-13880,-8200,80,-536,-6256,
-4264,7584,16232,10952,-1744,-7160,-2408,864,-5432,-13248,
-9648,4168,13440,9472,792,72,5936,5632,-5448,-15696,
};

static const short dtmf_4[] = {
11312,15416,10312,416,-7224,-8360,-4352,-200,200,-2488,
-4024,-768,6384,12144,10976,1992,-9632,-16184,-13128,-2560,
8352,12816,9216,1744,-3512,-3648,-792,424,-2408,-7040,
-8344,-3072,6664,14360,13952,4776,-7528,-15024,-13256,-4336,
5008,8864,6352,1536,-632,1152,3712,2576,-3408,-10400,
-12336,-6096,5360,14680,15464,7104,-4672,-12208,-11488,-4720,
2104,4312,2120,-304,840,5224,8392,5792,-2752,-12056,
-15208,-9056,2984,13176,15096,8256,-1864,-8344,-8032,-3400,
328,8,-2776,-3528,680,7896,12400,9336,-784,-11848,
-16368,-11136,280,10280,12840,7760,120,-4240,-3440,-472,
96,-3280,-7520,-7496,-960,8816,14992,12400,1848,-10024,
-15584,-11720,-1928,6704,9056,5488,720,-712,1512,3608,
1464,-5032,-11264,-11424,-3592,8000,15744,14216,4360,-7152,
-13000,-10464,-2968,3272,4408,1704,-304,1552,5976,8128,
4096,-5064,-13416,-14480,-6472,5864,14584,14280,5976,-4008,
-9136,-7456,-2408,744,-248,-2968,-2832,2208,9200,12224,
7336,-3584,-13680,-15992,-8784,3088,11824,12440,6104,-1408,
-4744,-3104,-200,-328,-4120,-7744,-6336,1248,10712,15128,
10400,-1136,-12168,-15600,-9816,480,8104,8928,4496,-8,
-680,1848,3328,208,-6568,-11768,-10088,-920,10400,16280,
12488,1496,-9344,-13328,-9128,-1200,4240,4320,1288,-192,
2312,6560,7544,2184,-7264,-14336,-13248,-3656,8552,15488,
12984,3536,-5952,-9576,-6648,-1432,1032,-560,-3024,-1944,
3752,10240,11616,5048,-6296,-15056,-15072,-6144,5752,12936,
11624,4304,-2800,-5032,-2688,-16,-864,-4888,-7696,-4896,
3504,12288,14736,8040,-4104,-13888,-15096,-7616,2808,9176,
8488,3424,-640,-544,2112,2856,-1152,-7936,-11872,-8368,
1816,12472,16264,10344,-1384,-11192,-13208,-7520,504,4984,
4072,888,32,3080,6944,6648,120,-9272,-14792,-11544,
-704,10936,15856,11280,1040,-7624,-9672,-5664,-512,1192,
-880,-2928,-904,5256,10952,10592,2528,-8832,-15928,-13648,
-3312,8192,13592,10440,2440,-4016,-5112,-2208,64,-1472,
-5536,-7360,-3216,5704,13472,13840,5384,-6928,-15128,-14088,
-5200,4976,9896,7792,2320,-1144,-328,2296,2208,-2576,
-9096,-11568,-6320,4552,14128,15688,7864,-4192,-12624,-12640,
-5728,2112,5488,3688,536,368,3816,7088,5472,-2016,
-11016,-14744,-9440,2272,12944,15688,9216,-1432,-8984,-9432,
-4552,320,1216,-1192,-2672,264,6648,11312,9168,-112,
-11088,-16264,-11760,-400,10312,13768,8936,576,-5008,-4984,
-1712,48,-2128,-6032,-6728,-1336,7776,14216,12464,2528,
-9512,-15848,-12616,-2664,6912,10248,6864,1232,-1512,-56,
};

static const short dtmf_5[] = {
11760,14736,7896,-1704,-6088,-3728,-112,-1096,-6256,-9088,
-4040,6976,15392,13672,2576,-9264,-13128,-7832,40,3192,
728,-1760,1088,8024,11848,6728,-5224,-15024,-14744,-4800,
6504,10744,6760,736,-752,2400,4312,-96,-8856,-14032,
-9424,2880,13704,14840,6376,-3848,-7872,-4784,-528,-936,
-5312,-7240,-1728,8672,15400,11784,-264,-11592,-13920,-7064,
1624,4840,2112,-656,1712,7672,10184,4152,-7528,-15776,
-13488,-2256,8976,12072,6752,-128,-2008,944,2696,-1472,
-9224,-12808,-6856,5600,15144,14312,4352,-6184,-9520,-5448,
-432,-288,-4048,-5344,288,9808,14792,9480,-3152,-13576,
-14128,-5728,3576,6552,3280,0,1800,6856,8280,1688,
-9376,-15896,-11680,528,11296,12944,6184,-1480,-3512,-488,
1376,-2352,-9032,-11160,-4192,8016,16000,13168,1928,-8576,
-10888,-5624,176,760,-2600,-3568,1896,10352,13624,6888,
-5928,-15096,-13728,-3872,5768,8184,4104,176,1384,5664,
6288,-512,-10680,-15376,-9416,3400,13304,13280,5048,-3224,
-5144,-1768,456,-2688,-8328,-9216,-1592,10000,16216,11448,
-768,-10856,-11840,-5264,1272,2120,-1112,-2032,3016,10312,
11992,4160,-8432,-16048,-12704,-1592,8056,9584,4480,-160,
520,4232,4352,-2336,-11384,-14280,-6824,6192,14880,13000,
3384,-5248,-6744,-2744,16,-2504,-7216,-7128,776,11448,
15800,9248,-3592,-12872,-12288,-4352,2800,3656,256,-872,
3600,9728,10024,1456,-10528,-16368,-11096,984,10280,10616,
4336,-1000,-680,2696,2624,-3688,-11488,-12680,-4064,8760,
15912,12112,1272,-7416,-8168,-3320,88,-1840,-5800,-5056,
2800,12312,14776,6688,-6392,-14496,-12152,-2896,4640,5224,
1392,-160,3640,8688,7864,-1056,-12112,-16048,-8976,3744,
12296,11176,3640,-2296,-2120,1216,1224,-4504,-11024,-10704,
-1272,10952,16336,10632,-1168,-9576,-9280,-3392,672,-792,
-4232,-3136,4368,12560,13224,3904,-8992,-15616,-11400,-976,
6672,6664,2160,32,3176,7304,5656,-3264,-13112,-15112,
-6464,6512,13952,11176,2416,-3936,-3640,-56,256,-4768,
-10064,-8480,1360,12656,16120,8616,-3832,-11568,-9952,-2944,
1720,536,-2664,-1512,5408,12216,11248,1064,-11264,-16136,
-10056,1312,8736,7848,2464,-272,2280,5712,3568,-5032,
-13496,-13608,-3696,9136,15136,10584,696,-5816,-5096,-1016,
-216,-4512,-8720,-6168,3728,13792,15272,6176,-6552,-13248,
-10104,-1944,3152,2008,-1240,-288,5888,11336,8984,-1680,
-13072,-16016,-8168,3856,10696,8632,2248,-1072,1064,4056,
1728,-6288,-13272,-11648,-824,11456,15752,9392,-1416,-7784,
-6344,-1552,-168,-3776,-7104,-3920,5680,14304,13840,3440,
};

static const short dtmf_6[] = {
12168,13656,5224,-2752,-2840,1296,632,-6944,-13056,-8648,
4528,14768,13000,2536,-5288,-4368,72,-800,-7608,-11376,
-4624,8608,16168,11056,-888,-7912,-5536,-536,-1416,-7288,
-8912,-528,11824,16176,7952,-4728,-10224,-6032,-392,-1208,
-6184,-6024,3200,13888,14792,3976,-8568,-11848,-5640,560,
-312,-4576,-3120,6200,14640,12160,-504,-11968,-12488,-4256,
2240,1024,-2824,-576,8216,14072,8568,-5032,-14520,-11936,
-1920,4400,2488,-1272,1312,9128,12336,4392,-9152,-15912,
-10152,1160,6744,3728,-232,2376,8960,9720,96,-12448,
-15952,-7216,4704,8888,4424,88,2568,7896,6592,-3880,
-14592,-14600,-3376,8320,10464,4328,-376,1976,6208,3352,
-7144,-15408,-11968,984,11568,11152,3304,-1592,824,4240,
408,-9424,-14864,-8328,5456,14048,10736,1368,-3368,-576,
2360,-1912,-10544,-13088,-4064,9568,15424,9136,-1336,-5416,
-1896,896,-3400,-10520,-10344,376,12896,15496,6408,-4544,
-7392,-2808,88,-3968,-9488,-6992,4552,15096,14184,2776,
-7888,-8912,-3032,64,-3672,-7712,-3456,8048,15960,11592,
-1424,-10960,-9672,-2400,816,-2704,-5528,-144,10544,15440,
7960,-5784,-13344,-9416,-888,2192,-1336,-3320,2576,11848,
13624,3648,-9832,-14704,-8032,1400,3952,80,-1432,4472,
11944,10768,-888,-13152,-14816,-5560,4240,5752,1216,-152,
5392,10928,7224,-5208,-15376,-13576,-2176,7288,7240,1784,
360,5376,9056,3424,-8872,-16280,-11056,1808,10152,8072,
1568,72,4560,6664,-216,-11552,-15776,-7472,5992,12424,
8000,504,-904,3224,4136,-3304,-13008,-13936,-3176,9944,
13768,6880,-1344,-2376,1688,1848,-5560,-13200,-11000,1408,
13208,13928,4696,-3784,-4008,312,96,-6808,-12200,-7304,
5816,15432,12784,1608,-6512,-5464,-600,-896,-7040,-10232,
-3272,9608,16360,10368,-2104,-9152,-6392,-816,-1064,-6376,
-7640,648,12416,15872,6888,-6080,-11312,-6528,-216,-472,
-5056,-4808,4064,14000,14032,2648,-9872,-12632,-5688,1160,
704,-3400,-2120,6648,14264,11040,-1912,-13064,-12848,-3840,
3184,2176,-1768,72,8192,13272,7232,-6352,-15264,-11824,
-1096,5568,3608,-488,1536,8648,11224,3016,-10224,-16200,
-9560,2304,7968,4656,160,2144,8112,8448,-1144,-13128,
-15744,-6224,6024,10000,5016,48,1928,6792,5328,-4840,
-14800,-13912,-2104,9624,11304,4488,-848,1024,5016,2272,
-7704,-15128,-10896,2384,12696,11608,3008,-2440,-296,3120,
-344,-9512,-14136,-7016,6808,14856,10728,640,-4472,-1712,
1480,-2256,-10168,-12008,-2664,10696,15800,8648,-2400,-6624,
-2888,376,-3296,-9736,-9064,1680,13656,15376,5504,-5816,
};

static const short dtmf_7[] = {
12504,12128,2632,-2064,2016,4248,-3728,-14200,-13096,184,
11144,9328,1456,312,5936,6112,-4656,-15424,-12872,336,
9064,5984,272,2760,9488,7536,-5344,-15704,-11880,424,
6392,2304,-832,5104,12464,8456,-5728,-15024,-10176,416,
3288,-1472,-1800,7200,14672,8832,-5768,-13424,-7896,312,
-64,-5136,-2568,8912,15984,8656,-5440,-10992,-5176,96,
-3472,-8456,-3120,10120,16320,7968,-4736,-7872,-2192,-216,
-6712,-11224,-3416,10728,15656,6824,-3688,-4248,848,-608,
-9584,-13288,-3480,10688,14048,5304,-2336,-352,3792,-1056,
-11912,-14520,-3304,9976,11576,3528,-768,3584,6440,-1512,
-13536,-14856,-2944,8632,8408,1608,928,7328,8640,-1928,
-14344,-14288,-2440,6712,4736,-320,2656,10640,10264,-2272,
-14288,-12856,-1832,4328,792,-2160,4304,13312,11232,-2488,
-13344,-10664,-1184,1624,-3184,-3776,5760,15176,11504,-2544,
-11576,-7848,-544,-1248,-6960,-5096,6912,16128,11064,-2424,
-9072,-4584,32,-4112,-10288,-6040,7680,16088,9968,-2096,
-5976,-1088,512,-6784,-12984,-6576,8000,15072,8296,-1576,
-2488,2424,880,-9096,-14872,-6688,7824,13128,6160,-880,
1192,5744,1104,-10896,-15848,-6384,7144,10376,3704,-40,
4840,8680,1192,-12064,-15848,-5704,5992,6984,1096,888,
8224,11040,1160,-12504,-14888,-4720,4408,3160,-1504,1856,
11144,12696,1032,-12176,-13024,-3496,2488,-856,-3952,2800,
13400,13560,824,-11096,-10384,-2136,344,-4832,-6080,3632,
14856,13584,592,-9304,-7120,-728,-1896,-8520,-7784,4296,
15416,12784,352,-6904,-3456,632,-4096,-11688,-8968,4728,
15032,11224,160,-4040,392,1872,-6128,-14144,-9568,4880,
13728,9008,24,-864,4200,2912,-7840,-15736,-9576,4720,
11568,6280,-16,2400,7720,3704,-9112,-16368,-9000,4240,
8680,3216,24,5592,10736,4208,-9864,-16000,-7896,3448,
5248,16,168,8480,13080,4408,-10016,-14656,-6352,2368,
1464,-3120,384,10896,14608,4328,-9552,-12424,-4472,1072,
-2432,-6016,656,12680,15240,3984,-8480,-9432,-2392,-376,
-6200,-8496,952,13712,14928,3424,-6840,-5872,-240,-1888,
-9624,-10416,1240,13912,13720,2696,-4736,-1952,1832,-3376,
-12464,-11656,1464,13256,11688,1872,-2272,2064,3728,-4728,
-14568,-12168,1608,11776,8960,1008,392,5960,5320,-5856,
-15784,-11936,1624,9552,5720,176,3104,9472,6528,-6664,
-16048,-10984,1496,6704,2168,-568,5696,12408,7288,-7088,
-15320,-9384,1216,3416,-1472,-1200,8000,14568,7576,-7080,
-13656,-7248,784,-120,-4984,-1672,9864,15840,7384,-6624,
-11152,-4728,216,-3704,-8152,-1968,11160,16136,6760,-5720,
};

static const short dtmf_8[] = {
11736,15720,9784,-1320,-9848,-10808,-5272,1352,4192,2672,
232,512,3624,5904,3432,-3808,-11048,-12128,-4712,7120,
15424,14136,3792,-8688,-15048,-11656,-1808,7208,9832,5976,
248,-2544,-1400,608,-160,-4080,-7448,-5792,1664,10456,
13816,8088,-3840,-14144,-15680,-7296,5216,13488,12624,4456,
-4480,-8296,-5960,-1248,1184,48,-1872,-808,3896,8592,
8208,1040,-8992,-14720,-11168,160,11968,16256,10264,-1600,
-11208,-12696,-6448,1904,6424,5304,1592,-288,1160,3360,
2328,-3008,-9128,-10424,-4096,6720,14712,13704,3624,-9032,
-15832,-12488,-1864,8440,11920,7664,272,-4448,-4176,-1304,
-16,-2024,-4848,-4248,1424,8928,12184,7272,-3752,-13736,
-15464,-7248,5576,14456,13816,4944,-5432,-10456,-8088,-1896,
2616,2784,472,-288,2368,6112,6360,760,-7912,-13280,
-10288,312,11832,16312,10432,-1848,-12264,-14200,-7400,2456,
8488,7768,2864,-1136,-1352,728,1208,-2072,-6928,-8424,
-3400,6088,13560,12872,3360,-9120,-16152,-12936,-1840,9448,
13664,9096,232,-6256,-6824,-3136,176,112,-2120,-2616,
1096,7120,10200,6264,-3544,-12912,-14800,-6984,5776,15008,
14592,5248,-6256,-12312,-9960,-2440,4024,5448,2776,168,
720,3448,4352,504,-6568,-11448,-9112,432,11344,15880,
10288,-2064,-12960,-15288,-8104,2968,10328,9984,4000,-2016,
-3864,-1888,96,-1024,-4496,-6200,-2632,5248,11992,11672,
3008,-8928,-15992,-13000,-1744,10192,15008,10232,152,-7920,
-9272,-4840,432,2296,664,-952,688,5064,7920,5104,
-3192,-11696,-13704,-6528,5808,15112,14928,5376,-6920,-13824,
-11512,-2864,5352,7968,4960,576,-984,672,2248,280,
-5000,-9280,-7696,512,10504,14976,9840,-2208,-13280,-15912,
-8552,3424,11872,11896,4976,-2872,-6280,-4440,-952,104,
-1912,-3816,-1840,4216,10064,10144,2592,-8456,-15360,-12680,
-1592,10648,15904,11048,24,-9368,-11440,-6360,720,4448,
3432,688,200,2832,5416,3840,-2704,-10112,-12200,-5888,
5656,14768,14816,5336,-7400,-14928,-12704,-3168,6560,10256,
6976,912,-2712,-2120,120,104,-3240,-6832,-6080,544,
9336,13640,9120,-2288,-13216,-16064,-8728,3800,13088,13440,
5768,-3696,-8536,-6840,-1928,1280,736,-1336,-1040,3016,
7824,8336,2128,-7712,-14264,-11992,-1392,10792,16336,11520,
-120,-10576,-13264,-7656,1048,6504,6080,2272,-336,488,
2768,2496,-2096,-8216,-10352,-5104,5312,13984,14272,5136,
-7672,-15600,-13512,-3344,7608,12248,8752,1168,-4400,-4856,
-1976,-8,-1344,-4184,-4320,512,7864,11896,8136,-2280,
-12744,-15744,-8640,4080,13928,14584,6352,-4448,-10552,-9024,
};

static const short dtmf_9[] = {
12184,15048,7368,-3448,-8712,-6176,-1032,456,-2264,-3920,
216,8264,12640,7432,-4960,-15072,-14544,-3768,8456,12888,
7800,-440,-4328,-2408,312,-1272,-6232,-8240,-2504,8216,
15112,11280,-1304,-13008,-14880,-6456,4392,9128,6056,760,
-616,2096,3504,-848,-8672,-12312,-6368,6120,15504,13920,
2544,-9432,-13048,-7264,1120,4728,2528,-192,1472,6248,
7736,1560,-9000,-15072,-10304,2608,13752,14616,5488,-5328,
-9496,-5896,-456,800,-1920,-3088,1448,9000,11904,5280,
-7224,-15832,-13208,-1288,10360,13128,6664,-1824,-5104,-2632,
96,-1640,-6208,-7192,-624,9712,14936,9264,-3896,-14416,
-14256,-4472,6240,9800,5672,120,-1000,1728,2672,-2016,
-9264,-11432,-4168,8280,16056,12400,24,-11224,-13128,-6008,
2528,5464,2704,-24,1768,6128,6608,-280,-10352,-14704,
-8176,5152,14984,13800,3408,-7136,-10056,-5400,232,1216,
-1536,-2256,2552,9456,10888,3048,-9272,-16168,-11512,1248,
12024,13032,5288,-3248,-5800,-2744,-8,-1872,-6000,-6008,
1176,10912,14384,7032,-6376,-15448,-13248,-2312,7992,10240,
5080,-624,-1440,1328,1856,-3040,-9576,-10280,-1912,10192,
16184,10552,-2520,-12760,-12848,-4520,3968,6104,2752,24,
1928,5832,5376,-2040,-11392,-13968,-5856,7552,15824,12600,
1192,-8816,-10360,-4704,1032,1664,-1128,-1472,3488,9632,
9616,784,-11040,-16088,-9520,3784,13408,12576,3704,-4680,
-6376,-2736,-8,-1960,-5624,-4736,2872,11784,13464,4640,
-8680,-16088,-11872,-40,9592,10408,4272,-1472,-1896,928,
1096,-3888,-9616,-8904,320,11808,15888,8424,-5024,-13984,
-12216,-2840,5392,6616,2672,-24,1960,5392,4080,-3664,
-12096,-12872,-3408,9752,16256,11056,-1112,-10320,-10392,-3792,
1920,2128,-736,-744,4240,9536,8152,-1424,-12496,-15584,
-7272,6248,14464,11768,1944,-6080,-6808,-2576,96,-1928,
-5120,-3424,4416,12328,12208,2160,-10760,-16312,-10160,2280,
10992,10296,3272,-2376,-2352,552,416,-4552,-9392,-7352,
2504,13088,15184,6072,-7424,-14856,-11232,-1008,6744,6960,
2440,-200,1864,4832,2768,-5112,-12464,-11472,-904,11688,
16264,9200,-3448,-11600,-10128,-2704,2848,2568,-376,-112,
4808,9184,6520,-3544,-13600,-14680,-4840,8560,15152,10616,
56,-7384,-7064,-2272,328,-1776,-4512,-2112,5760,12520,
10672,-336,-12544,-16104,-8168,4600,12136,9888,2088,-3328,
-2776,216,-160,-5016,-8920,-5672,4552,14008,14088,3568,
-9648,-15352,-9928,920,7992,7112,2056,-480,1664,4184,
1472,-6352,-12488,-9808,1584,13312,15848,7072,-5736,-12600,
-9568,-1440,3800,2968,-80,408,5168,8608,4792,-5512,
};

static const short dtmf_10[] = {
12592,13968,4696,-4496,-5464,-1144,-280,-5384,-9072,-3480,
8792,16064,10240,-3688,-12840,-10184,-1336,3256,800,-1688,
2440,9928,10744,616,-12424,-15920,-6544,6240,10824,5728,
-304,0,3752,2424,-6160,-13592,-10136,3192,14528,13592,
2616,-6800,-6992,-1800,-248,-4480,-7064,-944,10392,15432,
7544,-6768,-14448,-9736,360,5104,2296,-560,2904,9048,
8344,-2248,-13944,-14992,-3800,9000,12136,5424,-1496,-1488,
2064,760,-6944,-12544,-7360,6168,15800,12456,48,-9152,
-8144,-1856,392,-3160,-5016,1192,11280,14088,4512,-9632,
-15416,-8560,2552,7040,3504,0,2712,7688,5848,-4712,
-14720,-13344,-712,11568,12856,4440,-3184,-3136,592,-352,
-7032,-10944,-4456,8736,16328,10600,-2848,-11328,-8776,-1264,
1560,-1600,-3120,2792,11424,12152,1352,-12080,-15648,-6704,
5072,8872,4256,-48,1952,6000,3472,-6624,-14728,-11088,
2488,13728,12880,2808,-5224,-4752,-480,-856,-6488,-8960,
-1648,10736,16064,8152,-5872,-13144,-8760,-48,3136,0,
-1568,3768,10880,9792,-1720,-13944,-15104,-4264,7736,10384,
4424,-728,728,4192,1392,-7872,-13992,-8384,5608,15320,
12152,600,-7432,-6128,-1032,-720,-5416,-6792,856,12040,
15032,5256,-8808,-14408,-8040,1712,4928,1440,-488,4064,
9744,7208,-4504,-15104,-13792,-1384,10328,11416,3936,-1968,
-776,2472,-208,-8416,-12608,-5432,8424,16208,10680,-2024,
-9616,-7088,-976,0,-3976,-4648,2912,12608,13336,2104,
-11448,-15008,-6616,3920,6752,2552,-8,3736,8160,4600,
-6808,-15496,-11808,1736,12640,11816,2784,-3664,-2400,1016,
-1240,-8272,-10728,-2448,10760,16320,8552,-4904,-11560,-7488,
-280,1216,-2352,-2720,4376,12432,11096,-1080,-13608,-14848,
-4552,6384,8400,3160,-144,2848,6320,2176,-8504,-15120,
-9264,4904,14480,11512,1008,-5656,-3920,0,-1632,-7512,
-8528,360,12464,15640,5872,-7824,-13072,-7224,1016,2784,
-736,-1184,5176,11584,8496,-4096,-15120,-13920,-1960,8920,
9680,3168,-896,1544,4416,128,-9512,-14016,-6360,7888,
15704,10456,-1264,-7752,-5152,-456,-1400,-6264,-6216,2808,
13448,14232,2832,-10576,-14000,-6264,2824,4520,656,-168,
5304,10176,5752,-6744,-15896,-12256,984,11296,10432,2528,
-2184,0,2656,-1400,-9792,-12312,-3288,10496,16184,8696,
-3912,-9744,-5928,-304,-584,-4688,-3984,4728,13664,12192,
-376,-12952,-14224,-4632,5016,6224,1672,224,4800,8376,
3064,-8840,-15888,-9960,4096,13336,10536,1240,-3872,-1592,
1224,-2320,-9384,-10168,-256,12552,15888,6328,-6720,-11440,
-6112,480,680,-2984,-2040,6016,13144,9680,-3536,-14776,
};

static const short dtmf_11[] = {
12928,12432,2104,-3808,-600,1808,-4648,-12640,-9104,5352,
15400,10616,-1296,-5920,-1600,296,-6072,-11360,-4456,10024,
16136,7304,-5144,-7672,-2040,-464,-6352,-8920,360,13448,
14992,2840,-8904,-8648,-1656,-400,-5648,-5800,4736,15224,
12096,-2248,-11992,-8488,-368,368,-4272,-2520,8136,15176,
7784,-7328,-13896,-7024,1712,1600,-2632,400,10216,13408,
2624,-11736,-14240,-4288,4304,2904,-1168,2592,10824,10232,
-2720,-14864,-12856,-536,6984,3864,-224,3800,10056,6144,
-7584,-16312,-9832,3792,9256,4120,-24,4008,8208,1752,
-11376,-15872,-5464,8136,10656,3432,-616,3376,5696,-2344,
-13664,-13608,-280,11880,10800,1720,-1872,2200,3024,-5640,
-14232,-9824,5064,14464,9504,-872,-3496,896,656,-7784,
-13136,-5032,9904,15464,6760,-4048,-5072,-136,-1040,-8624,
-10632,120,13616,14664,2832,-7344,-6184,-576,-1880,-8216,
-7176,4984,15736,12080,-1840,-10232,-6456,-224,-1832,-6840,
-3328,8960,16008,8008,-6672,-12192,-5632,936,-1080,-4872,
344,11592,14432,2936,-11024,-12816,-3648,2752,64,-2784,
3360,12656,11288,-2496,-14288,-11856,-632,4880,1224,-1000,
5376,12144,7016,-7608,-15992,-9304,3064,6896,1984,144,
6248,10280,2224,-11768,-15856,-5384,6960,8344,2040,488,
6024,7472,-2448,-14456,-13872,-544,10496,8824,1200,40,
4960,4232,-6408,-15392,-10256,4632,13104,8048,-504,-1008,
3416,1088,-9208,-14520,-5480,9488,14320,5960,-2904,-2328,
1832,-1496,-10592,-12048,-152,13368,13872,2688,-5624,-3528,
600,-3216,-10536,-8400,5040,15760,11696,-1416,-8192,-4192,
16,-3928,-9224,-4112,9464,16344,7984,-5848,-10128,-4008,
232,-3696,-7024,192,12592,15032,3152,-10008,-10984,-2816,
1192,-2760,-4400,3952,14088,12016,-2192,-13288,-10464,-632,
2688,-1480,-1840,6728,13864,7704,-7392,-15184,-8464,2304,
4360,-264,216,8248,12072,2664,-11784,-15360,-5112,5632,
5784,496,1496,8480,9080,-2416,-14800,-13712,-752,8824,
6536,552,1880,7576,5392,-6920,-16072,-10384,4088,11352,
6304,-216,1456,5880,1576,-10304,-15472,-5776,8792,12736,
4920,-1752,456,3824,-1816,-12216,-13128,-448,12720,12640,
2400,-3784,-744,1856,-4376,-12528,-9400,4920,15312,10920,
-1008,-5944,-1752,368,-5840,-11352,-4824,9664,16184,7680,
-4896,-7768,-2192,-376,-6168,-9008,-24,13184,15176,3256,
-8720,-8808,-1816,-312,-5512,-5952,4360,15080,12392,-1832,
-11904,-8720,-528,472,-4176,-2720,7808,15160,8176,-6952,
-13920,-7312,1568,1720,-2576,184,9960,13520,3064,-11440,
-14384,-4624,4192,3040,-1128,2368,10656,10448,-2280,-14688,
};

static const short dtmf_12[] = {
12176,15904,8904,-3488,-12488,-12400,-4416,4952,9256,6744,
896,-3224,-3296,-1080,-8,-1488,-3464,-2544,2224,7704,
8792,3008,-6632,-13208,-11048,-584,11280,16024,9848,-3192,
-14024,-15184,-6208,6208,13432,11144,2096,-6632,-9336,-5576,
368,3704,2992,696,112,1904,3480,1680,-3560,-8392,
-7952,-880,8640,13504,9144,-2368,-13240,-15512,-7128,6264,
15328,13872,3296,-8656,-13832,-9480,224,8000,9056,4256,
-1536,-3984,-2592,-368,-296,-2288,-3320,-664,4832,8776,
6760,-1344,-10368,-13280,-6848,5272,14704,14400,4128,-9088,
-16040,-12040,-296,10736,13696,7496,-2480,-9000,-8432,-2840,
2552,4064,2136,128,568,2608,2976,-464,-5984,-8816,
-5248,3600,11728,12536,4248,-8016,-15608,-12720,-960,11560,
16120,9760,-2672,-12360,-13032,-5264,4576,9624,7512,1400,
-3392,-3960,-1640,16,-888,-2832,-2448,1672,6952,8504,
3464,-5776,-12656,-11272,-1440,10472,15920,10544,-2240,-13576,
-15584,-7128,5512,13488,11880,2896,-6416,-9848,-6344,0,
4016,3696,1152,-72,1240,2920,1744,-2904,-7696,-7832,
-1472,7800,13112,9552,-1456,-12552,-15608,-7944,5360,15064,
14448,4240,-8096,-14080,-10304,-480,7960,9680,4992,-1312,
-4424,-3296,-704,16,-1592,-2872,-880,4112,8168,6808,
-640,-9568,-13056,-7416,4344,14160,14688,5032,-8280,-15968,
-12760,-1216,10336,14112,8360,-1888,-9136,-9144,-3512,2488,
4616,2808,320,120,1912,2656,-96,-5232,-8320,-5464,
2816,11008,12496,4960,-7112,-15240,-13192,-1912,10880,16248,
10592,-1816,-12152,-13608,-6136,4120,9920,8280,1968,-3480,
-4600,-2256,-24,-336,-2168,-2272,1184,6208,8144,3840,
-4944,-12048,-11424,-2256,9632,15728,11176,-1280,-13048,-15904,
-8032,4752,13464,12584,3728,-6128,-10296,-7128,-440,4264,
4384,1680,-176,608,2328,1720,-2304,-6984,-7624,-1992,
6952,12648,9880,-568,-11808,-15616,-8720,4440,14720,14944,
5184,-7464,-14240,-11096,-1240,7832,10256,5752,-1008,-4808,
-4008,-1112,264,-912,-2368,-1016,3432,7520,6768,0,
-8752,-12760,-7912,3424,13552,14896,5904,-7432,-15816,-13416,
-2152,9864,14464,9216,-1224,-9192,-9824,-4224,2336,5120,
3504,592,-256,1216,2272,176,-4496,-7776,-5592,2072,
10256,12368,5600,-6192,-14792,-13592,-2856,10136,16296,11376,
-920,-11856,-14120,-7016,3592,10144,9024,2600,-3488,-5200,
-2904,-152,160,-1488,-2024,760,5456,7720,4136,-4144,
-11400,-11480,-3024,8760,15464,11744,-312,-12456,-16144,-8912,
3936,13360,13240,4592,-5752,-10680,-7912,-960,4424,5056,
2256,-192,16,1696,1624,-1768,-6256,-7352,-2440,6120,
};

static const short dtmf_13[] = {
12616,15232,6480,-5616,-11352,-7768,-176,4056,2792,144,
880,4528,5712,440,-8408,-12760,-6960,5808,15400,13464,
1168,-11560,-14760,-6928,4312,9792,6856,560,-2488,-952,
824,-1352,-6112,-7400,-1280,8768,13952,8288,-4936,-15272,
-14064,-2280,10344,13992,7120,-3096,-8104,-5680,-680,1064,
-928,-2016,1552,7496,9080,2304,-8832,-14896,-9552,3920,
14856,14400,3288,-9008,-12960,-7032,2016,6360,4280,528,
176,2816,3392,-1472,-8648,-10688,-3464,8624,15568,10696,
-2792,-14168,-14440,-4152,7608,11688,6656,-1120,-4608,-2688,
-104,-1200,-4640,-4896,1136,9544,12176,4712,-8152,-15952,
-11672,1616,13232,14184,4816,-6192,-10208,-6000,448,2896,
952,-576,1976,6352,6488,-552,-10152,-13496,-6000,7448,
16032,12448,-440,-12096,-13624,-5256,4824,8576,5080,-16,
-1280,872,1496,-2480,-7912,-8112,-240,10472,14600,7264,
-6552,-15816,-12968,-672,10792,12784,5440,-3544,-6832,-3896,
-152,-184,-2752,-2632,2720,9264,9712,1216,-10504,-15456,
-8464,5512,15304,13224,1688,-9384,-11680,-5344,2408,5024,
2496,48,1464,4616,3944,-2680,-10384,-11240,-2328,10248,
16032,9544,-4360,-14520,-13192,-2560,7904,10336,4968,-1456,
-3216,-912,312,-2528,-6416,-5384,2368,11232,12648,3528,
-9744,-16320,-10456,3160,13496,12856,3232,-6416,-8792,-4320,
720,1464,-800,-944,3336,8096,6904,-1816,-11800,-13872,
-4768,9000,16304,11160,-1960,-12272,-12232,-3680,4976,7096,
3400,-232,184,2608,1808,-3872,-9616,-8456,1056,12072,
14888,5984,-8064,-15984,-11616,816,10880,11328,3864,-3640,
-5304,-2232,8,-1688,-4456,-2888,4128,10920,9976,-112,
-12048,-15648,-7136,6976,15376,11808,216,-9384,-10152,-3784,
2440,3456,848,-56,3000,6288,4136,-4112,-11984,-11424,
-960,11744,16128,8160,-5784,-14504,-11712,-1104,7832,8752,
3424,-1424,-1608,704,368,-4080,-8040,-5504,3824,12776,
12744,2128,-11176,-16320,-9016,4544,13384,11320,1800,-6272,
-7160,-2792,632,-176,-2392,-944,4904,9672,6952,-3296,
-13280,-13880,-3328,10376,16200,9672,-3312,-12072,-10640,-2264,
4760,5424,1888,-88,1856,4168,1752,-5456,-11136,-8432,
2544,13488,14800,4512,-9392,-15784,-10080,2128,10600,9672,
2480,-3352,-3592,-752,-184,-3376,-5968,-2768,5720,12376,
9872,-1616,-13400,-15464,-5624,8248,15080,10216,-1056,-9024,
-8456,-2424,2096,1712,-592,192,4696,7752,3952,-5712,
-13376,-11240,560,13024,15848,6616,-7000,-14112,-10072,128,
7392,7016,2096,-1024,152,2112,56,-5784,-9448,-5256,
5432,14096,12464,576,-12392,-15944,-7432,5712,12904,9632,
};

static const short dtmf_14[] = {
13024,14152,3816,-6656,-8112,-2744,560,-1784,-4008,584,
9456,12320,3312,-10680,-16288,-7864,6240,12840,7744,-1112,
-4184,-1192,312,-3896,-8424,-4848,6536,15048,10840,-3440,
-14592,-12632,-1040,8032,7432,1632,-584,2352,3520,-2448,
-10824,-11192,-152,13048,15544,4728,-8800,-12744,-5792,2568,
4072,632,152,5024,8320,2680,-9072,-15272,-8128,6728,
15464,10584,-1640,-8928,-6456,-640,400,-2824,-2712,4368,
11736,9480,-3088,-14832,-14088,-1424,10880,12072,3712,-3736,
-3712,-192,-832,-6024,-7768,-240,11272,14784,5016,-9688,
-15624,-8120,4120,9336,5272,-168,-40,3128,1592,-6248,
-12136,-7248,6272,15952,12000,-1872,-12392,-10880,-1624,4560,
3176,-88,1688,6816,6760,-2352,-13024,-13600,-1648,12192,
15064,5376,-6272,-9272,-3976,768,-432,-3216,-216,7976,
11968,4592,-9224,-16344,-9376,5024,13288,9256,-360,-5040,
-2528,176,-2640,-7320,-5312,4984,14224,11760,-1808,-14112,
-13832,-2480,8016,8768,2648,-1120,960,3032,-1360,-9448,
-11216,-1632,11800,15984,6344,-7872,-13536,-7296,2152,5176,
1840,-48,3640,7480,3480,-7512,-14800,-9344,5192,15376,
12008,-400,-9272,-7888,-1376,1232,-1480,-2568,3072,10552,
9880,-1496,-13872,-14896,-3064,10296,13160,5120,-3672,-5000,
-1184,-296,-4600,-7240,-1336,9800,14696,6464,-8344,-15928,
-9672,3144,10024,6720,240,-1120,1920,1800,-4816,-11208,
-8000,4648,15336,13128,-312,-12184,-12192,-2856,4848,4560,
632,840,5440,6576,-1024,-11728,-13896,-3248,11120,15744,
6968,-5616,-10256,-5336,688,824,-2216,-768,6496,11360,
5664,-7664,-16112,-10752,3624,13456,10720,624,-5664,-3928,
-232,-1544,-6072,-5496,3496,13184,12432,-152,-13376,-14840,
-4032,7712,9984,3848,-1392,-392,2304,-504,-8000,-10960,
-2960,10400,16152,7904,-6720,-14080,-8824,1464,6088,3168,
16,2360,6440,4024,-5960,-14072,-10352,3576,15008,13280,
1008,-9344,-9272,-2352,1832,-96,-2152,1952,9224,9992,
8,-12712,-15448,-4704,9448,14040,6624,-3328,-6152,-2360,
-24,-3208,-6472,-2200,8272,14320,7752,-6856,-15944,-11152,
1944,10464,8176,928,-2008,600,1728,-3504,-10088,-8496,
3040,14480,14024,1320,-11688,-13360,-4248,4864,5880,1584,
240,4024,6128,112,-10312,-13912,-4744,9848,16152,8560,
-4704,-11024,-6784,336,1952,-1040,-1040,5056,10512,6496,
-6056,-15608,-11960,2088,13344,12096,1816,-6024,-5328,-896,
-656,-4728,-5400,2144,11960,12832,1464,-12384,-15616,-5640,
7136,11040,5200,-1384,-1688,1352,104,-6528,-10432,-4096,
8880,16024,9344,-5376,-14352,-10328,536,6784,4568,368,
};

static const short dtmf_15[] = {
13368,12616,1224,-5976,-3248,208,-3792,-9040,-4040,9424,
16064,6880,-8224,-12912,-5048,2616,1504,-1776,2480,10608,
9504,-3808,-15576,-12200,1952,10592,6728,-112,376,4272,
712,-9792,-13704,-3040,11936,14824,3896,-6632,-6264,-808,
-1344,-6640,-5152,6360,15424,9584,-6008,-14320,-8048,2320,
4312,72,704,7736,9672,-816,-14008,-14296,-816,11080,
9752,1096,-1936,1768,1640,-6736,-12904,-5664,9608,16096,
6952,-6152,-9008,-2824,256,-3728,-5144,3424,13720,11568,
-3152,-14648,-11064,928,6504,2680,-24,4704,8704,1696,
-11584,-15424,-3896,10432,12424,3256,-3376,-1176,1440,-3880,
-11080,-7504,6704,16264,9944,-4592,-11080,-5528,800,-728,
-4016,1024,11216,12544,-56,-13832,-13672,-1368,7784,5672,
360,1936,6752,3392,-8640,-15440,-6856,8720,14392,6064,
-3736,-4152,136,-1624,-8496,-8320,3616,15296,12480,-2168,
-12200,-8560,208,1944,-1928,-496,8248,12392,2840,-11992,
-15512,-4256,7960,8624,1840,-168,4088,4032,-5584,-14328,
-9296,6192,15352,9128,-2952,-6744,-2080,-272,-5504,-8000,
784,13336,14192,784,-12200,-11488,-1440,3920,808,-936,
5232,11136,5176,-9376,-16336,-7344,7000,11128,4200,-1336,
1088,3528,-2840,-12248,-10880,3184,15192,12024,-1136,-8576,
-4904,-24,-2544,-6592,-1408,10648,14864,3872,-11080,-13912,
-3928,4912,3824,-248,2592,8944,6600,-6344,-16016,-10192,
5032,12832,7104,-1392,-1816,1952,-784,-9504,-11384,120,
13920,14352,1464,-9392,-7936,-912,-16,-4288,-2664,7608,
14384,6656,-8984,-15480,-6904,4768,6688,1480,696,6144,
6928,-3320,-14600,-12416,2328,13480,10152,-320,-4232,-448,
280,-6472,-10744,-2576,11712,15784,4496,-9072,-10752,-2808,
1712,-1432,-2808,4640,12840,8768,-6208,-15976,-9952,3520,
9000,4008,-176,3120,6120,-712,-12296,-13712,-728,13000,
12912,1728,-5808,-3368,232,-3568,-9064,-4552,8880,16128,
7536,-7656,-12952,-5448,2408,1576,-1824,2160,10440,9904,
-3128,-15328,-12656,1320,10424,6984,64,296,4296,1096,
-9416,-13896,-3736,11432,15008,4480,-6320,-6368,-928,-1216,
-6576,-5520,5800,15336,10168,-5336,-14232,-8472,1960,4320,
136,504,7528,9920,-168,-13632,-14640,-1512,10760,9976,
1416,-1912,1712,1880,-6360,-12944,-6280,9008,16144,7544,
-5688,-9048,-3048,256,-3624,-5360,2912,13512,12024,-2432,
-14400,-11456,440,6408,2816,-80,4504,8816,2256,-11120,
-15632,-4600,9952,12584,3672,-3224,-1256,1536,-3560,-11008,
-8000,6048,16160,10504,-4000,-11008,-5824,656,-640,-4096,
616,10920,12856,656,-13440,-13984,-1952,7552,5824,456,
};

static const short *contactid_athena_dtmf_tone[16] = {
  dtmf_13,	// 0
  dtmf_0,	// 1
  dtmf_1,	// 2
  dtmf_2,	// 3
  dtmf_4,	// 4
  dtmf_5,	// 5
  dtmf_6,	// 6
  dtmf_8,	// 7
  dtmf_9,	// 8
  dtmf_10,	// 9
  dtmf_13,	// A	- il valore 10 corrisponde al tasto 0
  dtmf_12,	// B (*)
  dtmf_14,	// C (#)
  dtmf_3,	// D (A)
  dtmf_7,	// E (B)
  dtmf_11,	// F (C)
};

void CID_init()
{
  if(!CID_delay) CID_delay = timeout_init();
}

int CID_decode(int freq, short *sample)
{
  float Q0;
  float Q1_1, Q2_1, Q1_2, Q2_2;
  int i;
  
  /* Facendo dei test ho visto che con 160 campioni il filtro diventa troppo
     selettivo, e in particolare quello per i 2300Hz presenta due zeri all'interno
     della banda da considerare (+/-3%) a 2250 e 2350. La banda deve invece essere
     tra 2230 e 2370Hz minimo. Con 80 campioni invece la banda si allarga a coprire
     bene tutto l'intervallo.
     Sul filtro a 1400Hz lo zero cade sempre bene in centro sia con 80 che 160 campioni.
     
     Per la decodifica dei 1400Hz invece andrebbero bene sia 80 che 160 campioni.
     Con 160 cadono in tutto 3 zeri nella banda dei 2300Hz, a 2250, 2300 e 2350Hz.
     Con 80 campioni lo zero si ha solo a 2300Hz, ma le magnitudini nell'intorno
     rimangono ampiamente inferiori a quelle rilevate per 1400Hz.
     
     Quindo occorre gestire la decodifica dell'algoritmo di Goertzel con buffer
     di 80 campioni. */
     
  /* Calcolare sempre sia 1400 che 2300 per fare confronti relativi. */
  
  Q1_1 = Q2_1 = Q1_2 = Q2_2 = 0.0;
  for(i=0; i<80; i++)
  {
    Q0 = COEFF_1400 * Q1_1 - Q2_1 + (float)sample[i];
    Q2_1 = Q1_1;
    Q1_1 = Q0;
    Q0 = COEFF_2300 * Q1_2 - Q2_2 + (float)sample[i];
    Q2_2 = Q1_2;
    Q1_2 = Q0;
  }
  Q1_1 = Q1_1 * Q1_1 + Q2_1 * Q2_1 - Q1_1 * Q2_1 * COEFF_1400;
  Q1_2 = Q1_2 * Q1_2 + Q2_2 * Q2_2 - Q1_2 * Q2_2 * COEFF_2300;
  if((Q1_1 > THR) || (Q1_2 > THR))
  {
    if(((freq == 1400) && (Q1_1 > (Q1_2*3))) ||
       ((freq == 2300) && (Q1_2 > (Q1_1*3))))
      return 1;
  }
  return 0;
}

/* Preparo il buffer dati con i toni da trasmettere.
   Sono 16 toni spaziati da 15 silenzi, più il silenzio
   finale per arrivare a blocchi interi di PERIOD_SIZE. */
static unsigned short audio_tx_data[(((16+16)*NCTONE+PERIOD_SIZE-1)/PERIOD_SIZE)*PERIOD_SIZE];
static int audio_tx_idx;
/* Per la ricezione uso un buffer da 5K campioni, che è
   multiplo sia di 80 che di 1024. In questo modo posso
   gestirlo come buffer circolare senza avere sfridi. */
static unsigned short audio_rx_data[5*1024];
static int audio_rx_idx;
static int audio_rx_len;
static int audio_rx_out;
static pthread_mutex_t audio_rx_mutex = PTHREAD_MUTEX_INITIALIZER;

static int audio_tx_queue()
{
  int err;
  
  /* Se è stato accodato tutto l'audio del messaggio */
  if(audio_tx_idx >= (sizeof(audio_tx_data)/sizeof(short))) return 0;
  
  err = snd_pcm_writei(audio_handle_tx, audio_tx_data+audio_tx_idx, PERIOD_SIZE);
  if(err >= 0) audio_tx_idx += err;
  return err;
}

static void audio_tx_callback(snd_async_handler_t *ahandler)
{
  snd_pcm_t *handle = snd_async_handler_get_pcm(ahandler);
  snd_pcm_sframes_t avail;
  int err;
  
  avail = snd_pcm_avail_update(handle);
  while (avail >= PERIOD_SIZE)
  {
    err = audio_tx_queue();
    if(err <= 0) return;
    avail = snd_pcm_avail_update(handle);
  }
}

static void audio_tx_play(unsigned char *ev)
{
  int i, err;
  
  audio_tx_idx = 0;
  
  memset(audio_tx_data, 0, sizeof(audio_tx_data));
  for(i=0; i<16; i++)
    memcpy(audio_tx_data+(i*2*NCTONE), contactid_athena_dtmf_tone[ev[i]], sizeof(dtmf_0));
  
  if(snd_pcm_state(audio_handle_tx) == SND_PCM_STATE_XRUN)
    err = snd_pcm_recover(audio_handle_tx, -EPIPE, 1);
  
  for(i=0; i<8; i++) audio_tx_queue();
  //err = snd_pcm_start(audio_handle_tx);
}

static void audio_rx_callback(snd_async_handler_t *ahandler)
{
  /* Su iMX51 il callback funziona solo se si chiedono 2048 frames.
     Non ne arrivano di più, e di meno manda in overrun. */
  /* Anche 1024 va bene, la callback viene chiamata più frequente.
     Con 512 invece si va in overrun. */
  snd_pcm_t *handle = snd_async_handler_get_pcm(ahandler);
  int err;
  
  err = snd_pcm_readi (handle, audio_rx_data+audio_rx_idx, 1024);
  if(err < 0)
  {
    /* Overrun - faccio ripartire */
    err = snd_pcm_recover(handle, -EPIPE, 1);
    snd_pcm_start(handle);
  }
  else
  {
    audio_rx_idx += err;
    if(audio_rx_idx >= (sizeof(audio_rx_data)/sizeof(short)))
      audio_rx_idx = 0;
    pthread_mutex_lock(&audio_rx_mutex);
    audio_rx_len += err;
    pthread_mutex_unlock(&audio_rx_mutex);
  }
}

static int CID_tentativi = 0;

void contactid_close_on_error(int *msg)
{
  snd_pcm_close(audio_handle_tx);
  audio_handle_tx = NULL;
  snd_pcm_close(audio_handle_rx);
  audio_handle_rx = NULL;
  
  CID_tentativi++;
  if(CID_tentativi > 8)
  {
    CID_tentativi = 0;
    CID_set_error(2);
    *msg = 0;
  }
  else
    timeout_on(CID_delay, NULL, NULL, 0, CID_DELAY);
}

void CID_transmit(int fd, int *msg, unsigned char *ev)
{
  int i, err, rx_timeout;
  snd_pcm_hw_params_t *hw_params;
  snd_async_handler_t *ahandler;
  short *psamp;
  
  /* Verifico che l'audio sia abilitato al contactid */
  if(!audio_version || ((audio_version&0xff0000)<0x20000))
  {
    *msg = 0;
    CID_set_error(3);
    return;
  }
  
  /* Attivo gli stream audio */
  if((err = snd_pcm_open(&audio_handle_tx, "default", SND_PCM_STREAM_PLAYBACK, 0)) < 0)
  {
    support_log("Dispositivo audio non trovato.");
    return;
  }
  
  i = 8000;
  hw_params = NULL;
  if((snd_pcm_hw_params_malloc(&hw_params) < 0) ||
     (snd_pcm_hw_params_any(audio_handle_tx, hw_params) < 0) ||
     (snd_pcm_hw_params_set_access(audio_handle_tx, hw_params, SND_PCM_ACCESS_RW_INTERLEAVED) < 0) ||
     (snd_pcm_hw_params_set_format(audio_handle_tx, hw_params, SND_PCM_FORMAT_S16_LE) < 0) ||
     (snd_pcm_hw_params_set_rate_near(audio_handle_tx, hw_params, &i, 0) < 0) ||
     (snd_pcm_hw_params_set_channels(audio_handle_tx, hw_params, 1) < 0) ||
     (snd_pcm_hw_params(audio_handle_tx, hw_params) < 0))
  {
    snd_pcm_hw_params_free(hw_params);
    snd_pcm_close(audio_handle_tx);
    audio_handle_tx = NULL;
    return;
  }
  
  snd_pcm_hw_params_free(hw_params);
  err = snd_async_add_pcm_handler(&ahandler, audio_handle_tx, audio_tx_callback, NULL);
  
  if((err = snd_pcm_open(&audio_handle_rx, "default", SND_PCM_STREAM_CAPTURE, 0)) < 0)
  {
    snd_pcm_close(audio_handle_tx);
    audio_handle_tx = NULL;
    support_log("Dispositivo audio non trovato.");
    return;
  }
  
  i = 8000;
  hw_params = NULL;
  if((snd_pcm_hw_params_malloc(&hw_params) < 0) ||
     (snd_pcm_hw_params_any(audio_handle_rx, hw_params) < 0) ||
     (snd_pcm_hw_params_set_access(audio_handle_rx, hw_params, SND_PCM_ACCESS_RW_INTERLEAVED) < 0) ||
     (snd_pcm_hw_params_set_format(audio_handle_rx, hw_params, SND_PCM_FORMAT_S16_LE) < 0) ||
     (snd_pcm_hw_params_set_rate_near(audio_handle_rx, hw_params, &i, 0) < 0) ||
     (snd_pcm_hw_params_set_channels(audio_handle_rx, hw_params, 1) < 0) ||
     (snd_pcm_hw_params(audio_handle_rx, hw_params) < 0))
  {
    snd_pcm_hw_params_free(hw_params);
    snd_pcm_close(audio_handle_tx);
    audio_handle_tx = NULL;
    snd_pcm_close(audio_handle_rx);
    audio_handle_rx = NULL;
    return;
  }
  
  snd_pcm_hw_params_free(hw_params);
  
  err = snd_async_add_pcm_handler(&ahandler, audio_handle_rx, audio_rx_callback, NULL);
  
  contactid_sm = 0;
  contactid_sm_count = 0;
  contactid_idx = 0;
  
  audio_rx_idx = 0;
  audio_rx_len = 0;
  audio_rx_out = 0;
  snd_pcm_start(audio_handle_rx);
  
  while(1)
  {
    rx_timeout = 0;
    pthread_mutex_lock(&audio_rx_mutex);
    /* Se il gsm chiude non arrivano più dati audio,
       occorre quindi gestire un timeout che faccia
       uscire dal while. Deve arrivare un blocco audio
       ogni 125ms, ma mi cautelo un minimo di più. */
    while(audio_rx_len < 80)
    {
      pthread_mutex_unlock(&audio_rx_mutex);
      if(++rx_timeout > 20)	// basterebbe 13
      {
        contactid_close_on_error(msg);
        return;
      }
      usleep(10000);
      pthread_mutex_lock(&audio_rx_mutex);
    }
    audio_rx_len -= 80;
    pthread_mutex_unlock(&audio_rx_mutex);
    psamp = audio_rx_data + audio_rx_out;
    audio_rx_out += 80;
    if(audio_rx_out >= (sizeof(audio_rx_data)/sizeof(short)))
      audio_rx_out = 0;
    
    /* ContactID capture (10ms=80sample) */
    switch(contactid_sm)
    {
      case CID_ST_WAIT_HS:
        contactid_sm_count++;
#if 0
        /* Debug telefonico, invio a tempo e non su identificazione toni */
        if(contactid_sm_count > 200)
        {
          /* Dopo 2s di attesa procedo con l'invio */
            contactid_sm_count = 0;
            contactid_retry = 0;
printf("cid hs mute 2\n");
            contactid_sm = CID_ST_HS_MUTE_2;
        }
        else
#endif
        if(contactid_sm_count > 1000)
        {
          /* Il centro è muto da 10s */
          contactid_close_on_error(msg);
          return;
        }
        else if(CID_decode(1400, psamp))
        {
          contactid_sm_count = 0;
          contactid_sm = CID_ST_HS_1400;
        }
        break;
      case CID_ST_HS_1400:
        contactid_sm_count++;
        if(!CID_decode(1400, psamp))
        {
          if(contactid_sm_count < 13)
          {
            /* Tono breve, quindi ok */
            contactid_sm_count = 0;
            contactid_sm = CID_ST_HS_MUTE_1;
          }
          else
          {
            /* Tono lungo, altro formato. */
            contactid_sm_count = 0;
            contactid_sm = CID_ST_WAIT_HS;
          }
        }
        break;
      case CID_ST_HS_MUTE_1:
        contactid_sm_count++;
        if(CID_decode(2300, psamp))
        {
          contactid_sm_count = 0;
          contactid_sm = CID_ST_HS_2300;
        }
        else if(contactid_sm_count > 13)
        {
          /* Il secondo tono non è arrivato in tempo */
          contactid_sm_count = 0;
          contactid_sm = CID_ST_WAIT_HS;
        }
        break;
      case CID_ST_HS_2300:
        contactid_sm_count++;
        if(!CID_decode(2300, psamp))
        {
          if(contactid_sm_count < 13)
          {
            /* Tono breve, quindi handshake ok */
            contactid_sm_count = 0;
            contactid_retry = 0;
            contactid_sm = CID_ST_HS_MUTE_2;
          }
          else
          {
            /* Tono lungo, altro formato. */
            contactid_sm_count = 0;
            contactid_sm = CID_ST_WAIT_HS;
          }
        }
        break;
      case CID_ST_HS_MUTE_2:
        contactid_sm_count++;
        /* Qui devo semplicemente attendere 250ms prima
           di partire con la trasmissione dell'evento. */
        /* Ne aspetto 270 per sicurezza, è capitato di dover
           ripetere qualche invio che poi ha ricevuto l'ack.
           Le specifiche dicono "250 (max 300)". */
        if(contactid_sm_count > 26)
        {
          contactid_sm_count = 0;
          contactid_sm = CID_ST_TRANSMIT;
          audio_tx_play(ev);
        }
        break;
      case CID_ST_TRANSMIT:
        contactid_sm_count++;
        if(contactid_sm_count > 250)
        {
          /* Timeout riproduzione, il gsm ha chiuso */
          contactid_close_on_error(msg);
          return;
        }
        else if(snd_pcm_state(audio_handle_tx) != SND_PCM_STATE_RUNNING)
        {
          contactid_sm_count = 0;
          contactid_sm = CID_ST_WAIT_ACK;
        }
        break;
      case CID_ST_WAIT_ACK:
        contactid_sm_count++;
        if(contactid_sm_count >= 125)	// 1250ms
        {
          contactid_retry++;
          if(contactid_retry < 8)
          {
            /* Ritrasmetto l'evento in coda già pronto */
            contactid_sm_count = 0;
            contactid_sm = CID_ST_TRANSMIT;
            audio_tx_play(ev);
          }
          else
          {
            /* Chiudo la comunicazione e riprovo. Se ci sono
               più numeri configurati, chiama il numero successivo. */
            contactid_close_on_error(msg);
            return;
          }
        }
        else if(CID_decode(1400, psamp))
        {
          CID_tentativi = 0;
          contactid_sm_count = 0;
          contactid_retry = 0;
          contactid_sm = CID_ST_ACK;
        }
        break;
      case CID_ST_ACK:
        contactid_sm_count++;
        if(!CID_decode(1400, psamp))
        {
          if(contactid_sm_count >= 40)	// min 400ms
          {
            if(CID_get_message(ev))
            {
              /* Altro evento in coda */
              contactid_sm = CID_ST_HS_MUTE_2;
            }
            else
            {
              /* Fine invio */
              snd_pcm_close(audio_handle_tx);
              audio_handle_tx = NULL;
              snd_pcm_close(audio_handle_rx);
              audio_handle_rx = NULL;
              *msg = 0;
              timeout_on(CID_delay, NULL, NULL, 0, CID_DELAY);
              return;
            }
          }
          else
          {
            /* La segnalazione è stata troppo breve, provo ad
               aspettarne una più lunga (e corretta). */
            contactid_sm = CID_ST_WAIT_ACK;
          }
          contactid_sm_count = 0;
        }
        break;
      default:
        break;
    }
  }
}


