/*
   23-04-2007 - Aggiunto modem TDK.
*/

/*
hwtestserial -d /dev/ttyS2 -b 115200 -s 2 -tx AT\\B3 -txhex 0d -rx 1
hwtestserial -d /dev/ttyS2 -b 115200 -tx AT\\T9 -txhex 0d -rx 1
hwtestserial -d /dev/ttyS2 -b 19200 -tx ATE1 -txhex 0d -rx 1


hwtestserial -d /dev/ttyS2 -b 19200 -s 2 -tx AT\\B3 -txhex 0d -rx 1
hwtestserial -d /dev/ttyS2 -b 115200 -p odd -tx AT -txhex 0d -rx 1
*/

#include "protocol.h"
#include "support.h"
#include "contactid.h"
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <termios.h>

//#define DEBUG

static short ulaw[256] = {
0,-7903,-7647,-7391,-7135,-6879,-6623,-6367,-6111,-5855,
-5599,-5343,-5087,-4831,-4575,-4319,-4063,-3935,-3807,-3679,
-3551,-3423,-3295,-3167,-3039,-2911,-2783,-2655,-2527,-2399,
-2271,-2143,-2015,-1951,-1887,-1823,-1759,-1695,-1631,-1567,
-1503,-1439,-1375,-1311,-1247,-1183,-1119,-1055,-991,-959,
-927,-895,-863,-831,-799,-767,-735,-703,-671,-639,
-607,-575,-543,-511,-479,-463,-447,-431,-415,-399,
-383,-367,-351,-335,-319,-303,-287,-271,-255,-239,
-223,-215,-207,-199,-191,-183,-175,-167,-159,-151,
-143,-135,-127,-119,-111,-103,-95,-91,-87,-83,
-79,-75,-71,-67,-63,-59,-55,-51,-47,-43,
-39,-35,-31,-29,-27,-25,-23,-21,-19,-17,
-15,-13,-11,-9,-7,-5,-3,-1,8159,7903,
7647,7391,7135,6879,6623,6367,6111,5855,5599,5343,
5087,4831,4575,4319,4063,3935,3807,3679,3551,3423,
3295,3167,3039,2911,2783,2655,2527,2399,2271,2143,
2015,1951,1887,1823,1759,1695,1631,1567,1503,1439,
1375,1311,1247,1183,1119,1055,991,959,927,895,
863,831,799,767,735,703,671,639,607,575,
543,511,479,463,447,431,415,399,383,367,
351,335,319,303,287,271,255,239,223,215,
207,199,191,183,175,167,159,151,143,135,
127,119,111,103,95,91,87,83,79,75,
71,67,63,59,55,51,47,43,39,35,
31,29,27,25,23,21,19,17,15,13,
11,9,7,5,3,1,
};

static unsigned char dtmf_0[] = {
255,139,131,139,181,28,25,45,225,52,
22,14,27,159,134,129,142,44,9,7,
20,238,166,185,57,72,158,139,138,160,
20,2,3,23,159,139,142,163,76,99,
168,160,96,16,5,9,47,141,129,135,
163,28,17,28,65,87,34,20,26,174,
137,129,139,78,10,4,13,61,159,159,
195,75,172,145,140,155,29,4,1,15,
169,138,137,153,92,46,223,171,200,26,
9,9,33,146,130,132,153,30,13,17,
43,213,61,30,28,205,142,131,137,182,
13,2,9,40,157,150,164,221,193,155,
143,153,42,8,1,12,192,139,134,143,
198,35,43,206,194,37,14,10,27,154,
131,129,145,39,11,12,29,215,191,50,
34,75,150,135,136,164,16,2,5,28,
159,143,151,180,116,172,152,154,64,12,
2,9,62,140,131,139,173,31,27,48,
213,54,22,13,24,165,134,128,140,57,
11,7,19,82,170,191,50,62,159,139,
137,156,24,3,2,19,165,141,142,162,
88,228,164,157,209,18,5,8,39,143,
130,134,159,31,19,29,67,85,33,18,
24,185,138,129,137,204,12,4,13,51,
162,162,205,67,173,144,139,151,32,5,
0,14,178,140,138,152,229,51,203,167,
188,27,9,8,29,149,130,131,150,36,
14,18,42,224,57,28,26,100,143,131,
135,171,14,3,8,35,160,152,166,236,
194,155,142,150,48,9,0,10,110,140,
134,143,187,40,46,194,187,39,13,9,
23,158,132,129,143,46,13,12,28,250,
200,46,31,60,151,135,135,158,19,2,
4,25,164,145,152,180,247,170,150,151,
96,13,2,7,47,142,132,138,168,35,
29,52,203,56,21,12,21,172,135,128,
139,83,13,8,18,67,174,203,46,55,
160,139,136,152,27,4,2,16,172,142,
143,162,108,209,161,155,190,19,5,6,
31,146,131,134,156,36,21,30,70,86,
};
static unsigned char dtmf_1[] = {
255,138,132,144,80,34,62,177,72,16,
6,14,172,134,131,147,47,24,39,207,
59,18,10,22,157,131,131,152,31,16,
29,80,61,23,14,31,149,130,132,159,
22,12,24,70,83,29,20,47,144,129,
134,176,14,8,21,83,193,42,29,95,
142,130,138,78,10,6,20,203,170,76,
41,189,142,133,142,40,6,4,22,175,
157,184,60,178,143,136,150,27,3,4,
27,159,148,165,101,177,145,140,159,18,
1,5,35,150,142,157,215,186,151,144,
178,14,1,7,56,143,138,153,228,225,
159,153,105,12,1,10,191,138,136,152,
73,56,174,163,54,11,3,15,164,134,
134,154,47,36,235,177,44,12,6,23,
152,131,133,158,33,26,50,201,42,14,
10,33,144,129,134,168,24,17,37,125,
45,17,15,54,141,128,136,193,15,13,
30,122,58,25,22,206,138,129,139,56,
11,10,29,203,226,34,31,175,137,130,
143,32,7,8,29,178,175,53,44,166,
138,133,152,23,3,7,33,163,159,215,
62,163,139,137,163,15,1,7,45,153,
151,176,94,165,142,141,188,11,0,9,
80,144,144,166,125,171,147,148,64,9,
0,12,178,140,140,161,79,188,155,157,
42,8,2,16,159,135,138,162,55,74,
167,169,32,8,4,25,149,132,137,167,
39,42,190,186,30,9,8,38,142,129,
137,178,28,29,73,215,30,11,12,69,
138,128,139,254,19,21,48,113,33,15,
18,184,136,128,141,46,13,15,41,223,
43,21,27,165,134,129,146,30,9,13,
40,190,67,30,38,157,134,132,155,20,
5,11,44,171,189,44,55,154,135,135,
169,13,2,11,58,158,166,75,86,154,
137,140,215,9,1,12,213,150,155,194,
222,156,140,144,48,6,0,15,172,142,
148,178,229,160,144,154,32,5,1,20,
157,138,143,175,76,173,152,164,26,4,
};
static unsigned char dtmf_2[] = {
255,137,134,154,56,76,161,170,22,3,
7,77,140,139,161,80,170,147,161,20,
1,7,63,143,145,177,213,153,140,156,
19,1,8,59,152,158,88,193,143,135,
152,20,2,10,58,162,198,42,188,139,
131,148,23,5,13,61,187,40,27,188,
137,129,147,26,10,21,73,63,22,18,
192,135,129,147,31,15,32,236,39,13,
13,204,135,130,148,39,27,69,190,29,
8,10,243,136,132,152,49,48,171,174,
24,4,7,78,139,137,158,68,186,153,
164,21,2,6,64,142,142,169,242,158,
142,157,20,1,7,58,148,153,202,200,
147,137,153,20,2,9,56,157,173,51,
191,141,133,149,22,4,12,58,174,57,
31,189,138,130,147,25,8,16,64,110,
28,22,192,136,129,146,30,13,27,91,
46,15,14,203,135,129,147,36,22,46,
201,32,10,11,235,136,131,150,46,37,
189,178,26,5,8,80,138,135,155,60,
255,158,167,23,2,7,64,141,140,163,
91,166,145,159,21,1,6,58,145,147,
182,209,152,139,154,20,1,8,54,154,
162,70,195,143,134,150,22,3,10,55,
166,232,38,191,139,131,147,25,6,14,
60,195,36,25,193,137,129,145,28,11,
22,75,58,20,16,203,135,129,146,33,
17,36,219,38,12,12,229,136,130,148,
42,29,93,185,29,7,9,83,137,133,
152,54,57,167,171,24,3,7,65,140,
137,158,75,177,150,160,22,1,6,57,
143,143,172,227,156,141,155,21,1,7,
53,150,155,220,201,146,136,151,22,2,
9,52,159,181,46,194,141,132,147,24,
5,12,56,179,47,29,194,138,129,145,
27,9,17,64,80,26,19,202,136,128,
145,31,14,29,103,44,14,13,224,136,
129,146,40,24,53,193,31,9,10,86,
136,131,150,49,42,179,175,26,5,7,
66,139,135,155,65,204,155,164,23,2,
};
static unsigned char dtmf_3[] = {
255,136,137,169,68,159,149,53,5,3,
34,152,157,73,181,139,134,172,11,8,
32,197,35,18,81,136,129,152,28,27,
212,76,13,5,28,142,135,155,76,169,
145,173,11,0,16,163,154,245,85,144,
132,148,21,7,22,224,46,17,31,143,
128,140,47,25,76,189,21,4,14,157,
135,145,213,183,146,153,23,1,9,216,
154,189,52,155,133,138,45,8,14,62,
64,19,19,160,130,134,183,27,52,175,
35,6,7,112,138,141,177,207,149,144,
51,4,4,36,157,173,46,174,136,133,
172,12,11,41,102,24,14,78,135,130,
155,33,41,174,71,10,3,28,144,138,
161,120,156,141,170,11,1,19,169,166,
47,77,141,130,147,22,10,28,246,31,
12,29,143,129,142,53,36,179,181,17,
2,13,158,138,152,232,165,141,150,22,
1,11,221,163,57,43,152,130,138,46,
11,21,80,44,13,16,159,131,136,186,
36,195,165,31,4,6,104,140,145,192,
180,142,141,51,5,6,40,166,89,33,
171,134,132,172,14,15,54,62,16,11,
75,135,132,157,41,92,159,66,8,2,
29,146,142,174,206,147,138,168,11,3,
23,175,198,31,71,139,129,148,25,14,
39,108,23,9,27,143,130,144,60,60,
160,174,15,0,14,160,142,161,103,156,
137,147,22,3,13,229,182,33,36,148,
129,138,48,14,29,224,32,9,14,159,
132,138,190,51,165,158,28,2,6,98,
143,154,110,168,138,139,51,6,8,44,
179,41,27,168,132,132,173,18,24,96,
49,12,9,72,136,134,161,53,173,152,
63,6,2,29,150,149,203,191,142,135,
167,11,5,27,186,52,23,65,138,128,
149,28,20,61,95,16,6,26,143,133,
149,69,190,151,171,13,0,14,164,147,
180,82,149,134,146,22,5,16,237,77,
23,31,146,128,138,52,20,45,195,27,
};
static unsigned char dtmf_4[] = {
255,138,130,140,210,20,16,31,95,223,
44,32,70,151,136,138,176,13,0,6,
43,144,135,142,180,36,35,69,209,45,
20,16,39,150,132,133,157,18,3,6,
31,156,143,151,183,74,189,162,171,37,
12,8,24,155,131,130,148,29,8,9,
29,175,159,175,88,196,155,143,153,42,
8,2,14,168,134,130,144,50,16,16,
37,215,253,42,36,201,145,136,142,69,
9,0,10,218,140,135,145,232,31,37,
79,235,38,18,18,64,143,131,136,178,
12,1,9,49,150,142,154,199,72,183,
163,184,28,10,10,35,144,129,132,159,
20,6,11,40,166,158,180,88,183,152,
144,160,28,6,4,22,153,131,132,152,
32,14,19,45,199,92,40,41,174,142,
136,147,35,5,1,15,167,137,136,152,
57,29,39,95,87,32,17,23,187,139,
130,140,61,8,1,13,207,144,142,158,
124,73,178,165,223,22,9,12,65,140,
128,135,184,14,6,14,60,159,159,187,
96,173,150,146,174,19,4,6,35,143,
130,134,164,24,13,22,57,191,76,40,
48,162,140,137,156,23,2,2,24,153,
135,137,159,42,28,42,123,67,29,18,
29,164,136,131,144,32,5,2,18,170,
142,143,165,74,77,175,169,61,17,9,
16,178,136,128,140,57,10,6,18,206,
156,160,194,247,167,149,150,232,14,3,
9,72,139,129,138,191,18,13,26,78,
188,66,41,66,155,138,139,172,15,1,
5,38,144,133,139,172,32,28,46,239,
56,26,19,38,153,134,133,155,21,2,
4,27,156,141,145,173,61,87,174,174,
43,14,9,23,158,132,129,145,31,7,
7,25,175,154,163,205,213,162,148,154,
48,10,3,13,174,135,129,142,57,14,
13,30,216,188,60,43,219,150,138,142,
105,10,0,9,83,140,133,142,204,28,
28,52,243,47,24,21,58,145,132,136,
};
static unsigned char dtmf_5[] = {
255,137,131,145,52,24,34,105,62,23,
14,32,148,130,133,171,14,6,17,245,
167,199,51,190,144,137,149,27,3,3,
29,150,139,149,199,70,173,159,107,15,
4,13,169,133,131,151,33,17,29,77,
65,27,19,52,143,130,137,91,9,5,
20,181,157,175,73,180,146,140,160,18,
1,6,46,142,136,149,103,48,192,170,
56,14,7,21,154,130,132,159,24,13,
26,81,89,32,27,218,141,131,141,39,
5,4,25,164,150,166,254,179,149,144,
181,14,1,9,205,138,135,152,56,36,
78,185,45,14,10,31,144,129,134,177,
15,11,26,226,198,43,36,177,140,133,
149,25,2,5,33,153,144,160,225,185,
154,151,78,11,2,13,165,134,134,156,
38,28,51,207,42,16,14,54,140,128,
138,70,11,9,27,187,175,62,48,168,
140,136,159,15,1,7,54,144,141,158,
100,205,159,159,45,10,4,21,152,131,
134,165,27,21,42,250,44,20,20,198,
138,129,142,35,7,8,31,170,163,219,
67,163,141,140,184,11,0,10,192,140,
139,159,63,73,170,171,35,9,7,32,
143,129,136,187,19,16,38,236,50,25,
28,170,136,131,150,23,4,8,41,158,
155,185,99,163,143,145,62,8,1,14,
162,136,138,163,46,47,188,188,30,10,
11,59,138,128,139,61,13,14,37,201,
69,31,39,159,135,134,161,14,1,10,
64,150,150,175,246,167,147,154,38,6,
2,22,150,133,138,173,33,35,112,220,
29,12,15,186,135,128,143,34,9,12,
40,180,205,43,55,155,136,138,190,10,
0,12,186,143,145,172,91,174,153,164,
28,5,5,35,142,130,139,200,25,28,
63,94,30,15,24,162,133,130,152,22,
6,12,48,167,176,60,90,153,138,142,
53,6,1,16,161,139,143,174,62,190,
160,180,23,6,9,68,137,129,142,57,
};
static unsigned char dtmf_6[] = {
255,136,133,155,42,41,187,202,21,6,
15,158,131,134,172,27,31,238,69,18,
10,30,143,128,138,66,17,26,77,57,
19,14,77,137,128,145,29,12,24,83,
60,24,24,166,133,131,160,15,9,26,
204,88,30,39,152,131,136,78,8,7,
31,174,191,41,76,144,132,143,28,4,
9,49,159,172,59,186,142,136,159,14,
1,12,189,149,162,93,173,142,141,235,
8,1,20,157,143,158,236,171,145,150,
33,3,3,37,144,139,159,84,176,151,
165,20,2,8,192,137,138,166,54,196,
159,210,13,3,16,154,132,139,186,37,
76,173,49,11,6,32,141,130,142,58,
27,49,194,37,11,12,212,135,130,151,
30,19,42,236,32,13,20,158,130,132,
170,17,14,40,239,35,18,36,144,129,
137,57,10,13,45,196,42,26,102,139,
130,145,25,6,13,66,174,58,38,171,
137,133,163,13,3,16,185,161,237,57,
158,137,139,66,6,3,26,159,153,188,
101,155,139,147,27,2,5,46,147,147,
179,213,155,142,165,15,0,10,179,140,
144,182,238,158,150,94,9,1,19,152,
136,144,206,65,166,160,38,6,5,39,
140,133,149,58,45,180,178,26,6,10,
185,134,133,157,34,32,216,236,21,8,
19,153,130,135,182,22,26,75,66,20,
12,38,141,128,140,47,14,23,68,62,
23,18,202,136,129,149,24,10,22,94,
79,28,29,160,133,132,171,13,7,26,
189,200,37,47,150,132,138,49,6,7,
33,167,174,51,239,144,134,147,23,2,
9,62,154,163,79,183,143,138,168,12,
0,13,173,145,158,227,175,144,143,61,
6,1,23,152,140,156,242,177,149,155,
29,3,5,47,141,138,158,67,191,156,
174,18,2,11,173,135,137,168,44,89,
167,86,13,4,20,149,131,139,202,30,
52,184,46,12,8,43,139,129,143,45,
};
static unsigned char dtmf_7[] = {
255,135,136,171,47,176,159,34,4,6,
224,138,142,184,216,153,152,30,2,7,
215,142,152,219,170,141,146,27,1,9,
209,151,173,68,156,136,143,25,3,12,
209,166,56,51,148,131,143,25,6,17,
216,111,28,43,142,129,143,26,10,28,
235,36,15,39,140,128,145,29,17,46,
94,22,10,37,139,129,149,35,31,195,
75,13,6,36,139,132,155,45,86,162,
62,9,4,38,140,137,164,70,163,151,
55,5,3,40,143,143,182,193,147,143,
49,4,4,44,150,157,87,171,139,140,
46,4,7,50,159,197,47,159,134,138,
44,6,11,60,182,39,34,153,130,137,
44,9,17,77,59,21,28,149,128,138,
45,14,30,247,32,12,24,146,128,140,
47,24,62,206,21,7,22,144,130,144,
54,44,173,194,14,3,22,145,134,152,
66,188,153,190,11,1,23,148,140,162,
117,157,143,188,8,1,25,152,148,190,
194,144,138,189,7,3,29,159,167,55,
178,138,135,191,8,6,36,172,67,33,
170,134,133,196,10,12,47,214,29,24,
163,131,133,203,14,20,71,49,15,17,
159,130,135,214,21,36,202,32,9,14,
157,130,138,228,32,211,178,24,4,13,
157,133,142,249,67,159,169,17,1,13,
157,137,151,123,173,146,163,14,0,14,
159,143,166,248,154,139,159,13,1,17,
165,155,250,227,143,134,158,12,3,23,
173,184,39,212,139,131,159,13,8,30,
190,44,24,201,135,130,160,15,13,45,
84,23,15,192,133,131,165,21,25,92,
49,13,12,188,133,133,170,29,48,178,
37,8,9,184,134,137,178,46,175,162,
29,3,8,182,137,142,191,211,152,155,
25,1,9,182,141,153,225,167,141,150,
22,1,10,183,150,175,76,153,136,147,
20,2,14,188,165,56,60,144,131,146,
20,5,19,197,104,28,53,141,129,147,
};
static unsigned char dtmf_8[] = {
255,137,129,141,58,13,11,27,186,159,
171,221,206,163,153,165,34,10,8,29,
148,130,132,162,15,2,9,51,148,141,
152,220,44,57,203,99,32,19,25,181,
139,133,144,33,4,1,19,155,134,135,
158,30,16,24,59,188,243,50,69,161,
143,144,191,14,3,10,227,136,128,140,
54,10,7,23,177,151,155,182,90,189,
165,173,40,14,12,32,149,131,133,163,
14,1,7,50,143,137,146,219,30,31,
59,122,48,29,31,185,142,136,147,34,
5,2,19,154,132,133,156,27,11,16,
49,171,170,207,90,173,152,151,198,17,
6,12,216,137,128,139,50,8,4,19,
172,143,145,169,61,58,199,188,47,21,
15,37,152,133,135,165,14,0,7,50,
141,133,142,221,23,21,39,225,233,47,
43,190,148,140,151,36,7,3,20,153,
131,131,155,23,8,12,44,160,154,170,
226,199,165,159,206,22,9,14,209,138,
129,140,47,7,2,16,168,140,140,160,
48,33,49,235,63,30,24,43,155,136,
137,168,14,1,6,52,140,131,140,228,
17,14,29,209,173,201,64,200,156,145,
156,39,9,5,22,153,130,131,155,21,
5,9,41,155,145,156,204,64,201,174,
218,28,14,18,206,139,131,141,46,6,
1,15,165,137,137,156,41,23,30,64,
235,49,34,50,159,140,140,171,15,2,
7,54,139,129,138,249,14,10,23,199,
158,165,200,223,169,155,161,42,12,8,
25,154,131,131,155,19,3,7,39,150,
140,148,193,42,47,233,234,38,21,24,
205,142,133,142,46,6,0,15,162,134,
134,153,35,15,21,49,187,199,58,63,
168,145,144,175,18,4,8,57,139,128,
137,104,11,6,18,191,150,152,174,87,
207,170,172,47,16,12,28,155,133,132,
156,18,1,5,37,146,136,143,189,31,
29,48,124,58,31,31,206,145,137,144,
};
static unsigned char dtmf_9[] = {
255,136,130,147,36,15,24,63,208,46,
33,222,144,135,147,28,2,3,34,143,
135,145,80,31,45,216,59,23,16,44,
144,130,138,58,6,3,23,159,142,152,
198,74,175,164,67,15,8,23,152,130,
133,172,13,6,19,189,157,172,96,184,
151,146,183,14,2,12,171,133,131,154,
27,13,25,80,197,49,39,184,142,137,
155,19,1,6,59,140,134,150,50,28,
43,236,53,23,20,74,141,131,142,33,
4,4,30,151,141,154,232,63,180,171,
48,14,10,31,144,129,136,249,10,6,
24,172,154,170,121,179,152,150,90,12,
3,16,156,131,133,165,20,12,27,221,
188,55,46,172,141,139,168,14,0,9,
187,136,134,155,38,25,42,124,50,24,
24,189,139,132,148,23,2,6,45,145,
140,156,74,56,186,178,40,13,12,49,
140,128,139,44,7,7,30,160,152,170,
248,177,153,155,47,10,5,25,146,129,
135,188,15,12,29,191,181,61,56,164,
141,141,197,10,0,13,162,134,135,163,
29,23,42,124,48,26,29,169,137,134,
158,15,0,9,116,141,140,159,56,49,
193,190,33,13,14,215,137,129,143,28,
5,8,41,155,150,171,120,176,155,160,
35,8,7,37,141,128,138,62,12,12,
34,177,175,71,71,159,141,144,57,7,
1,19,151,132,137,177,24,21,43,235,
49,28,37,158,136,136,175,11,0,12,
174,138,140,166,45,45,205,210,30,14,
19,172,134,130,152,19,3,10,63,149,
149,172,95,178,157,170,28,8,9,66,
137,128,142,37,9,12,42,169,171,84,
106,157,142,150,36,5,3,29,143,130,
139,241,19,20,46,215,51,30,47,153,
135,139,86,7,0,16,158,136,141,175,
37,42,222,99,28,14,26,158,133,132,
164,13,2,12,193,145,148,175,79,181,
159,184,23,7,13,182,134,129,148,25,
};
static unsigned char dtmf_10[] = {
255,135,133,157,30,26,61,90,27,14,
36,143,128,140,35,7,12,58,166,197,
53,172,140,139,203,8,1,22,151,139,
153,88,255,162,173,24,5,12,167,131,
133,171,21,20,51,92,30,20,64,140,
130,146,21,4,13,213,156,174,76,169,
142,144,46,5,3,34,142,136,155,56,
56,175,198,21,7,19,152,129,136,243,
14,16,50,211,39,28,188,138,132,158,
13,2,15,172,148,164,255,170,146,153,
29,3,6,71,137,135,158,39,39,203,
86,20,10,30,143,128,139,41,10,15,
59,182,54,39,170,138,136,186,8,1,
22,156,143,159,114,176,152,164,22,3,
10,172,133,135,170,27,29,79,67,22,
14,53,139,128,144,25,6,15,114,167,
255,54,162,139,141,52,5,2,31,146,
140,158,71,199,159,185,17,5,15,154,
130,136,203,19,24,63,71,27,21,195,
136,130,155,15,4,16,180,156,184,78,
160,141,148,30,2,5,57,140,138,161,
48,69,172,95,15,7,26,143,128,139,
48,13,20,64,255,32,30,169,135,134,
175,9,3,22,161,149,172,125,162,144,
158,21,2,9,180,135,137,170,35,45,
191,60,16,11,44,139,128,143,29,9,
18,90,188,45,42,159,136,138,62,5,
3,30,151,143,167,101,169,151,174,15,
2,14,157,132,137,191,26,33,255,53,
18,15,213,136,129,153,17,6,20,191,
170,71,60,156,137,143,32,2,5,48,
142,141,167,66,183,158,232,13,4,23,
145,129,139,59,17,28,79,57,23,23,
170,134,132,169,11,5,23,169,158,201,
98,155,140,153,21,1,8,192,138,139,
172,46,255,171,57,13,8,38,139,128,
143,33,13,25,89,76,29,32,157,133,
136,84,7,4,30,156,151,181,222,157,
144,168,15,1,12,160,134,139,188,33,
54,188,45,14,12,92,135,129,151,21,
};
static unsigned char dtmf_11[] = {
255,135,136,175,34,75,179,30,7,14,
155,130,139,59,25,54,217,24,10,30,
140,128,147,28,18,48,79,23,14,213,
134,131,169,14,15,53,83,26,25,157,
130,136,46,8,15,85,212,31,44,144,
130,145,19,5,20,180,182,43,210,140,
134,171,9,4,31,159,169,61,171,139,
140,42,3,7,77,148,161,94,162,140,
152,18,0,13,162,142,160,121,160,144,
180,10,1,26,144,139,165,74,165,153,
45,5,5,90,137,139,180,50,174,168,
26,4,13,156,132,141,67,36,194,201,
17,6,28,141,130,149,32,28,102,63,
15,11,233,133,131,169,19,24,76,50,
16,20,156,129,136,50,12,23,94,50,
21,37,142,129,144,22,8,26,193,62,
29,214,137,132,169,10,7,35,170,239,
42,165,135,138,44,4,9,74,157,188,
63,155,136,148,18,1,14,168,149,176,
229,151,140,174,9,1,27,149,144,176,
207,152,147,44,4,5,77,139,143,188,
245,156,159,23,2,12,158,134,144,78,
63,165,190,14,4,26,141,132,152,41,
45,178,56,11,8,100,134,133,170,26,
36,203,38,11,15,156,129,137,57,16,
31,250,33,14,32,141,128,145,25,12,
32,221,35,20,224,135,131,167,12,10,
41,188,42,31,161,132,136,46,6,11,
74,170,56,50,149,133,146,19,2,15,
173,159,91,222,144,136,171,9,2,28,
154,153,206,184,143,142,45,3,5,70,
143,150,205,177,146,155,21,0,12,160,
138,151,94,184,153,182,12,2,25,143,
135,157,52,208,162,51,8,6,80,135,
135,173,34,71,178,31,7,14,157,130,
139,63,25,52,213,25,10,29,141,128,
146,29,17,46,84,24,14,121,134,130,
166,15,15,51,88,26,24,159,130,136,
50,9,15,77,207,31,42,145,130,144,
21,5,19,182,180,43,225,140,133,168,
};
static unsigned char dtmf_12[] = {
255,136,129,142,36,7,8,30,156,142,
149,194,38,38,62,124,56,36,44,174,
146,143,168,22,6,10,75,138,129,141,
39,4,2,23,151,134,138,175,22,14,
26,213,163,168,200,234,177,164,181,36,
15,17,66,143,133,142,45,6,2,20,
151,130,133,166,15,5,13,221,144,142,
159,55,32,43,85,89,46,38,73,157,
143,149,58,12,6,21,155,131,132,160,
14,1,8,89,139,133,146,44,14,15,
41,171,160,175,232,204,171,168,79,24,
15,27,163,137,135,159,16,1,7,64,
137,128,141,43,8,6,27,158,141,146,
185,37,33,53,250,66,41,44,181,149,
143,164,25,7,10,56,139,129,139,46,
5,1,20,154,134,137,169,23,13,23,
255,160,163,189,111,187,169,180,41,18,
17,56,145,134,141,56,7,1,17,155,
130,132,159,16,4,12,79,145,141,156,
58,30,38,72,250,54,41,66,160,144,
149,74,13,6,19,159,132,131,156,16,
1,7,60,140,132,144,49,14,14,36,
172,158,170,216,233,177,171,107,27,16,
26,169,138,135,156,20,2,6,49,139,
128,139,51,8,5,24,160,140,144,176,
36,30,46,121,87,47,46,188,151,144,
161,28,8,10,46,141,129,138,59,6,
1,16,157,134,135,162,24,12,20,80,
159,159,181,98,203,173,180,45,20,18,
48,149,135,141,76,9,1,15,158,131,
131,155,19,4,10,60,145,140,153,63,
29,32,62,219,65,45,63,165,146,149,
255,15,7,17,165,133,131,153,19,1,
6,47,141,132,142,60,14,13,31,173,
156,164,203,91,188,174,225,30,17,26,
175,140,136,154,24,3,5,41,140,128,
138,65,9,4,20,163,140,142,171,36,
27,41,101,228,56,48,198,154,146,160,
32,10,9,40,143,130,137,88,8,0,
14,161,134,134,158,25,11,17,64,158,
};
static unsigned char dtmf_13[] = {
255,135,130,150,26,10,17,97,160,170,
229,194,158,153,208,15,7,21,153,130,
134,189,9,3,21,159,141,149,204,44,
64,196,58,24,19,59,143,133,144,28,
2,4,46,140,133,148,39,16,26,73,
190,65,48,183,146,142,173,15,3,13,
161,131,132,166,14,7,20,176,151,159,
205,226,169,165,56,15,11,36,143,129,
139,42,4,4,32,146,137,150,61,30,
42,106,60,30,29,189,141,136,157,16,
1,9,182,134,132,157,24,12,24,208,
169,192,76,176,151,150,77,12,6,24,
147,129,136,80,8,5,27,157,143,156,
123,59,194,183,44,17,16,93,139,131,
147,22,1,7,73,139,135,154,36,21,
33,100,96,42,43,170,142,141,188,11,
2,15,154,130,134,180,14,9,27,173,
156,172,242,184,158,161,43,12,10,45,
140,129,141,31,4,6,43,145,140,156,
56,38,65,216,44,23,27,173,138,135,
164,13,0,11,167,134,135,166,23,15,
31,199,184,69,64,165,144,149,50,9,
5,29,142,128,138,48,8,8,35,156,
148,165,93,224,171,179,33,13,15,190,
136,131,152,16,1,9,196,139,138,161,
35,27,46,252,53,30,41,160,139,140,
106,8,1,20,148,130,137,222,14,12,
34,172,164,195,113,168,151,160,32,8,
10,64,137,128,144,25,4,9,62,145,
143,165,57,54,200,212,32,16,26,162,
135,135,175,10,0,14,158,134,138,179,
23,20,42,202,98,45,64,157,141,149,
38,6,5,37,140,128,141,38,8,11,
46,157,155,177,108,178,159,180,26,10,
15,172,134,131,158,14,1,12,175,139,
141,172,37,35,70,96,37,24,42,153,
136,141,54,6,2,26,144,130,140,62,
14,15,45,175,180,75,223,157,145,161,
25,6,10,204,134,129,150,20,4,12,
231,147,148,175,63,228,175,240,25,13,
};
static unsigned char dtmf_14[] = {
255,134,132,162,22,16,42,204,51,32,
204,141,136,166,11,0,17,151,135,145,
62,31,60,216,33,15,29,150,130,139,
37,3,7,63,144,147,181,76,173,164,
44,11,10,100,134,130,157,15,7,25,
171,160,202,228,156,144,171,14,2,16,
149,130,139,53,14,23,74,211,41,42,
159,137,141,39,3,4,57,139,136,162,
34,34,96,68,24,17,93,138,131,156,
13,1,16,160,142,155,98,117,167,182,
23,8,19,151,129,136,50,8,11,54,
158,167,108,181,149,149,45,6,5,53,
136,130,155,23,14,32,198,81,38,94,
145,136,158,14,0,14,156,134,142,85,
28,44,225,43,19,27,156,132,137,51,
4,5,44,144,143,171,61,192,168,58,
13,10,53,137,129,151,17,5,19,175,
156,178,115,163,147,164,18,3,14,155,
130,136,83,14,17,57,188,56,43,167,
139,141,56,5,3,40,140,134,156,35,
28,60,89,30,19,58,141,131,150,16,
1,13,167,140,149,221,61,177,179,29,
10,16,158,130,134,88,8,8,41,157,
158,202,196,154,150,63,9,5,38,138,
129,148,26,12,27,200,196,46,70,150,
138,154,18,0,11,163,134,139,202,26,
33,93,55,24,26,164,134,136,101,6,
3,32,146,140,161,57,83,173,78,16,
10,40,140,128,145,21,4,15,184,152,
167,250,173,151,160,24,4,12,164,131,
134,191,14,14,45,178,107,47,176,142,
140,253,7,2,29,141,132,150,37,24,
45,121,38,22,46,144,132,145,21,1,
10,177,139,144,193,48,203,180,36,12,
15,168,132,132,186,9,6,31,157,153,
182,221,160,152,234,12,5,29,141,128,
143,29,10,21,215,176,63,63,156,139,
150,24,1,9,175,134,136,179,24,27,
66,73,29,27,175,137,135,184,8,1,
26,148,138,155,57,53,186,234,22,11,
};
static unsigned char dtmf_silence[] = {
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,
};

static unsigned char *dtmf_tone[16] = {
  dtmf_13,	// 0
  dtmf_0,	// 1
  dtmf_1,	// 2
  dtmf_2,	// 3
  dtmf_4,	// 4
  dtmf_5,	// 5
  dtmf_6,	// 6
  dtmf_8,	// 7
  dtmf_9,	// 8
  dtmf_10,	// 9
  dtmf_13,	// A	- il valore 10 corrisponde al tasto 0
  dtmf_12,	// B (*)
  dtmf_14,	// C (#)
  dtmf_3,	// D (A)
  dtmf_7,	// E (B)
  dtmf_11,	// F (C)
};

int ser_setspeed(int fdser, int baud, int timeout);
char* ser_send_recv(int fdser, char *cmd, char *buf);

#define LIMIT 8192

#define smul(a,b) ( (a)*(b) )
#define sround( x )  ( ( (x) + (LIMIT/2) ) / LIMIT )

#define S_MUL(a,b) sround( smul(a,b) )
#define SQRTMOD 45

static int sqrt_int(int val)
{
  int res, lastres, diff, n;
  
  val *= 4;
  lastres = val/200+2;
  n = 0;
  
  do
  {
    n++;
    res = (val/lastres + lastres) / 2;
    diff = res - lastres;
    lastres = res;
  }
  while((diff > 1)||(diff < -1));
  
  return (int)(res*SQRTMOD);
}

static int FFTint(int dir, int m, int *x, int *y)
{
   int n,i,i1,j,k,i2,l,l1,l2;
   int c1,c2,tx,ty,t1,t2,u1,u2,z;

   /* Calculate the number of points */
   n = 1 << m;

   /* Do the bit reversal */
   i2 = n >> 1;
   j = 0;
   for (i=0;i<n-1;i++) {
      if (i < j) {
         tx = x[i];
         ty = y[i];
         x[i] = x[j];
         y[i] = y[j];
         x[j] = tx;
         y[j] = ty;
      }
      k = i2;
      while (k <= j) {
         j -= k;
         k >>= 1;
      }
      j += k;
   }

   /* Compute the FFT */
   c1 = -LIMIT; 
   c2 = 0;
   l2 = 1;
   for (l=0;l<m;l++) {
      l1 = l2;
      l2 <<= 1;
      u1 = LIMIT; 
      u2 = 0;
      for (j=0;j<l1;j++) {
         for (i=j;i<n;i+=l2) {
            i1 = i + l1;
            t1 = S_MUL(u1, x[i1]) - S_MUL(u2, y[i1]);
            t2 = S_MUL(u1, y[i1]) + S_MUL(u2, x[i1]);
            x[i1] = x[i] - t1; 
            y[i1] = y[i] - t2;
            x[i] += t1;
            y[i] += t2;
         }
         z = S_MUL(u1, c1) - S_MUL(u2, c2);
         u2 = S_MUL(u1, c2) + S_MUL(u2, c1);
         u1 = z;
      }
      c2 = sqrt_int((LIMIT - c1) / 2);
      if (dir == 1) 
         c2 = -c2;
      c1 = sqrt_int((LIMIT + c1) / 2);
   }

   /* Scaling for forward transform */
   if (dir == 1) {
      for (i=0;i<n;i++) {
         x[i] /= n;
         y[i] /= n;
      }
   }
   
   return 1;
}

static char* cid_send_recv(int fd, char *cmd, char *buf)
{
  char tbuf[128];
  int i, n;
  
  if(!buf) buf = tbuf;
  
  write(fd, cmd, strlen(cmd));
  
  i = 0;
  while((n = read(fd, buf+i, 128-i)))
  {
    i += n;
    if(i == 128) return NULL;
  }
  
  buf[i] = 0;
  
  if(buf == tbuf) buf = NULL;
  return buf;
}

static const int cid_freq[] = {11,12,14,15, 19,21,24,26, 22,36,4,5, 6,7,8};
//static const int cid_freq[] = {11,12,14,15, 19,21,24,26, 22,36,4,5, 6,23,37};

static int cid_dtmf_decode(int *x2, int *y2, int nfreq)
{
  int i, j, v, f[sizeof(cid_freq)/sizeof(int)];
  
  j = -1;
  
  for(i=0; i<(sizeof(cid_freq)/sizeof(int)); i++)
  {
    if(x2[cid_freq[i]] < 0) x2[cid_freq[i]] = -x2[cid_freq[i]];
    if(y2[cid_freq[i]] < 0) y2[cid_freq[i]] = -y2[cid_freq[i]];
    f[i] = x2[cid_freq[i]]>y2[cid_freq[i]]?x2[cid_freq[i]]:y2[cid_freq[i]];
//    f[i] = x2[cid_freq[i]]*x2[cid_freq[i]] + y2[cid_freq[i]]*y2[cid_freq[i]];
  }
  
  j = 0;
  
  v = 0;
  for(i=0; i<nfreq; i++) if(f[i] > v) v = f[i];
  v /= 2;
  if(v < 200) v = 200;
//  if(v < 300) v = 300;
  for(i=0; i<(sizeof(cid_freq)/sizeof(int)); i++)
    if(f[i] > v) j |= (1<<i);
  
#ifdef DEBUG
{
static int oldj = 0;
if(!j)
{
  printf(".");
  fflush(stdout);
}
else
{
  if(!oldj) printf("\n");
  printf("%d - %3d %3d %3d %3d %3d %3d %3d %3d   (%3d %3d)   %3d %3d %3d %3d %3d\n", v, f[0], f[1], f[2], f[3], f[4], f[5], f[6], f[7], f[8], f[9], f[10], f[11], f[12], f[13], f[14]);
}
oldj = j;
}
#endif
  if((j & 0x0120) == 0x0120)
  {
    if(f[5] > f[8])
      j &= ~0x0100;
    else
      j &= ~0x0020;
  }
  if((j & 0x0280) == 0x0280)
  {
    if(f[7] > f[9])
      j &= ~0x0200;
    else
      j &= ~0x0080;
  }
  
  return j;
}

/****************************************
    Decodifica IMA ADPCM
****************************************/

static void ima_init(IMA *ima)
{
  ima->predictor = 0;
  ima->step_index = 0;
  ima->step = ima_step_table[0];
}

static int ima_decode(IMA *ima, int code)
{
  int diff;
  
  ima->step_index = ima->step_index + ima_index_table[code];
  if(ima->step_index < 0)
    ima->step_index = 0;
  else if(ima->step_index >= MAX_STEP)
    ima->step_index = MAX_STEP-1;
  
  if(code & 0x08) code = -(code&0x07)-1;
  diff = (ima->step * code / 4) + (ima->step / 8);
  ima->predictor = ima->predictor + diff;
  if(ima->predictor < -(PREDICT_LIMIT+1))
    ima->predictor = -(PREDICT_LIMIT+1);
  else if(ima->predictor > PREDICT_LIMIT)
    ima->predictor = PREDICT_LIMIT;
  
  ima->step = ima_step_table[ima->step_index];
  
  return SHIFT(ima->predictor);
}

/****************************************
    Gestione SiLab
****************************************/

static int cid_SiLab_read_tone(int fd, int mezzisecondi, void *null)
{
  unsigned char buf[128];
  int n, x[128], y[128], i, s, t, v;
  
  i = 0;
  s = 0;
  v = 0;
  t = mezzisecondi * 31;
//#warning
//printf("Timeout %.1f secondi (%d campioni)\n", mezzisecondi/2.0, t);
  
  while((s != 6) && t)
  {
    n = read(fd, buf+i, 128-i);
    
    if(!n) return 0;
    
    i += n;
    if(i == 128)
    {
//#warning
//printf(" %d %d   \r", s, t); fflush(stdout);
      for(i=0; i<128; i++)
      {
        x[i] = ulaw[buf[i]];
        y[i] = 0;
      }
      FFTint(1, 7, x, y);
      n = cid_dtmf_decode(x, y, 10);
//if(s!=1) printf("%d %04x %04x %d\n", s, n, v, t);
      switch(s)
      {
        case 0:
          if(!n) s++;
          break;
        case 1:
          if(n) s++;
          break;
        case 2:
          if(!v)
          {
            if(n && ((!(n & 0x300)) || (n == 0x100) || (n == 0x200)))
              v = n;
            else
              s--;
          }
          if(v && !n) s++;
          // fermo il timeout se sto ricevendo un tono
          t++;
          break;
        case 3:	// il periodo viene chiuso da più di 3 frame a zero
        case 4:
        case 5:
          if(n)
            s = 2;
          else
            s++;
          break;
        default:
          break;
      }
      
      i = 0;
      t--;
    }
  }
//#warning
//printf("\n%04x\n", v);  
  return v;
}

static int cid_SiLab_free_busy(int fd, void *null)
{
  unsigned char buf[128];
  int n, x[128], y[128], i, t;
  
  i = 0;
  t = 62;	// 1s
  
  while(t)
  {
    n = read(fd, buf+i, 128-i);
    i += n;
    if(i == 128)
    {
      for(i=0; i<128; i++)
      {
        x[i] = ulaw[buf[i]];
        y[i] = 0;
      }
      FFTint(1, 7, x, y);
      n = cid_dtmf_decode(x, y, 10);
      
      /* Se ricevo un tono entro 1s è il tono di occupato. */
      if(n)
      {
//printf("CID: linea occupata\n");
        return 1;
      }
      i = 0;
      t--;
    }
  }
  /* E' scaduto il timeout, quindi suona libero. */
//printf("CID: linea libera.\n");
  return 0;
}

static void cid_SiLab_init(int fd)
{
  char buf[64];
  
  /* Configurazione no echo, 115200 8X1 */
  write(fd, "ATX3E0\\B6\\T12\r", 14);
  while(read(fd, buf, 64));
  
  ser_setspeed(fd, B115200|CRTSCTS|CMSPAR|PARENB, 5);
  
  /* connessione host <-> DAA, ulaw, 8000Hz */
  cid_send_recv(fd, "AT:U71,0019\r", NULL);
  write(fd, "ATH\r", 4);
  while(read(fd, buf, 64));
  
  ser_setspeed(fd, B115200|CRTSCTS|CMSPAR|PARENB, 100);
}

static void cid_SiLab_call(int fd, char *number)
{
  char buf[32];
  
  sprintf(buf, "ATDT%s\r", number);
  write(fd, buf, strlen(buf));
}

static void cid_SiLab_send(int fd, unsigned char *code)
{
  int i;
  char buf[128];
  
  for(i=0; i<5; i++)	// 250ms
    write(fd, dtmf_silence, sizeof(dtmf_silence));
  support_log("ContactID: trasmissione messaggio.");
  for(i=0; i<16; i++)
  {
    write(fd, dtmf_tone[code[i]], sizeof(dtmf_silence));	// 50ms
    write(fd, dtmf_silence, sizeof(dtmf_silence));
  }
  for(i=0; i<(sizeof(dtmf_silence)*32);)
  {
    i += read(fd, buf, 128);
  }
  tcdrain(fd);
  tcflush(fd, TCIOFLUSH);
}

static void cid_SiLab_hangup(int fd)
{
  char buf[64];
  
  support_log("ContactID: hangup.");
  buf[0] = 0;
  ser_setspeed(fd, B115200|CRTSCTS|CMSPAR|PARENB|PARODD, 0);
  write(fd, buf, 1);
  ser_setspeed(fd, B115200|CRTSCTS|CMSPAR|PARENB, 5);
  write(fd, "AT\r", 3);
  read(fd, buf, 64);  
  write(fd, "ATH\r", 4);
  while(read(fd, buf, 64));  
  ser_setspeed(fd, B115200|CRTSCTS|CMSPAR|PARENB, 100);
  sleep(1);
}

/****************************************
    Gestione USRobotics
****************************************/

static void cid_USR_init(int fd)
{
  ser_setspeed(fd, B115200|CRTSCTS, 5);
  cid_send_recv(fd, "ATE0M0X3\r", NULL);
}

static void cid_USR_call(int fd, char *number)
{
  int i;
  char buf[32];
  
  ser_setspeed(fd, B115200|CRTSCTS, 5);
  cid_send_recv(fd, "AT#CLS=8#VLS=0#VBT=1#VRN=0#VSM=130,8000\r", NULL);
  ser_setspeed(fd, B115200|CRTSCTS, 600);
  
  sprintf(buf, "ATDT%s\r", number);
  write(fd, buf, strlen(buf));
  
  buf[0] = 0;
  while(read(fd, buf, 1) && ((buf[0]=='\r')||(buf[0]=='\n')));
  
  if(buf[0] && !((buf[0]=='\r')||(buf[0]=='\n')))
  {
    for(i=1; i<31; i++)
    {
      if(!read(fd, buf+i, 1) || (buf[i]=='\n')) break;
    }
    if(strncmp(buf, "VCON", 4)) return;
  }
  
  write(fd, "AT#VRX\r", 7);
  
  buf[0] = 0;
  while(read(fd, buf, 1) && ((buf[0]=='\r')||(buf[0]=='\n')));
  
  if(buf[0] && !((buf[0]=='\r')||(buf[0]=='\n')))
  {
    for(i=1; i<31; i++)
      if(!read(fd, buf+i, 1) || (buf[i]=='\n')) break;
    if(strncmp(buf, "CONNECT", 7)) return;
  }
}

static void cid_USR_hangup(int fd)
{
  char buf[64];
  
#ifdef DEBUG
printf("hangup\n");
#endif
  support_log("ContactID: hangup.");
  buf[0] = 0x10;
  buf[1] = '!';
  ser_setspeed(fd, B115200|CRTSCTS, 5);
  write(fd, buf, 2);
  while(read(fd, buf, 64));  
  write(fd, "AT\r", 3);
  read(fd, buf, 64);  
  write(fd, "ATH\r", 4);
  while(read(fd, buf, 64));  
#ifdef DEBUG
printf("hangup ok\n");
#endif
}

static int cid_USR_read_tone(int fd, int mezzisecondi, void *data)
{
  unsigned char buf[128];
  int n, m, x[128], y[128], i, j, s, t, v, esc;
  
  i = 0;
  j = 0;
  s = 0;
  v = 0;
  t = mezzisecondi * 31;
  esc = 0;
  
  while((s != 6) && t)
  {
    m = read(fd, buf, 128);
    
    if(!m) return 0;
    for(i=0; i<m; i++)
    {
      if(esc || (buf[i] == 0x10))
      {
        if(!esc)
        {
          i++;
          if(i >= m)
          {
            esc = 1;
            break;
          }
        }
        esc = 0;
        if(buf[i] != 0x10) continue;
      }
      
      x[j] = ima_decode((IMA*)data, buf[i] >> 4);
      y[j] = 0;
      j++;
      x[j] = ima_decode((IMA*)data, buf[i] & 0xf);
      y[j] = 0;
      j++;
      
      if(j == 128)
      {
        FFTint(1, 7, x, y);
        n = cid_dtmf_decode(x, y, 15);
        switch(s)
        {
          case 0: if(!n) s++; break;
          case 1: if(n) s++; break;
          case 2:
            if(!v)
            {
              if(n && ((!(n & 0x300)) || (n == 0x100) || (n == 0x200)))
                v = n;
              else
                s--;
            }
            if(v && !n) s++;
            // fermo il timeout se sto ricevendo un tono
            t++;
            break;
          case 3: case 4: case 5:
            if(n) s = 2; else s++; break;
          default: break;
        }
        
        j = 0;
        t--;
      }
    }
  }
  
  return v;
}

static int cid_USR_free_busy(int fd, void *data)
{
  unsigned char buf[128];
  int n, x[128], y[128], i, j, t, esc;
  
  i = 0;
  j = 0;
  t = 62;
  esc = 0;
  
  while(t)
  {
    n = read(fd, buf, 128);
    
    if(!n) return 0;
    for(i=0; i<n; i++)
    {
      if(esc || (buf[i] == 0x10))
      {
        if(!esc)
        {
          i++;
          if(i >= n)
          {
            esc = 1;
            break;
          }
        }
        esc = 0;
        if(buf[i] != 0x10) continue;
      }
      
      x[j] = ima_decode((IMA*)data, buf[i] >> 4);
      y[j] = 0;
      j++;
      x[j] = ima_decode((IMA*)data, buf[i] & 0xf);
      y[j] = 0;
      j++;
      
      if(j == 128)
      {
        FFTint(1, 7, x, y);
        n = cid_dtmf_decode(x, y, 15);
        
        /* Se ricevo un tono entro 1s è il tono di occupato. */
        if(n)
        {
          support_log("CID: linea occupata.");
          return 1;
        }
        
        j = 0;
        t--;
      }
    }
  }
  
  /* E' scaduto il timeout, quindi suona libero. */
  support_log("CID: linea libera.");
  return 0;
}

static const char cid_idx_to_tone[16] = "01234567890*#ABC";

static void cid_USR_send(int fd, unsigned char *code)
{
/*
at#vbt=1 (toni da 1/10s)
at#vts=1,2,3,4,5,6... (sequenza di cifre)
*/
  char buf[64];
  int i;
  
  buf[0] = 0x10;
  buf[1] = '!';
  write(fd, buf, 2);
  ser_setspeed(fd, B115200|CRTSCTS, 5);
  while(read(fd, buf, 64));
  
  sprintf(buf, "at#vts=");
  for(i=0; i<16; i++)
  {
    buf[i*2+7] = cid_idx_to_tone[code[i]];
    buf[i*2+8] = ',';
  }
  buf[38] = '\r';
  write(fd, buf, 39);
  ser_setspeed(fd, B115200|CRTSCTS, 50);
  while(read(fd, buf, 64));
  
  write(fd, "AT#VRX\r", 7);
  
  buf[0] = 0;
  while(read(fd, buf, 1) && ((buf[0]=='\r')||(buf[0]=='\n')));
  
  if(buf[0] && !((buf[0]=='\r')||(buf[0]=='\n')))
  {
    for(i=1; i<31; i++)
      if(!read(fd, buf+i, 1) || (buf[i]=='\n')) break;
    if(strncmp(buf, "CONNECT", 7)) return;
  }
}

/****************************************
    Gestione TDK
****************************************/

static int cid_TDK_send_recv(int fd, char *cmd, int len, char *buf)
{
  int i, n;
  
  write(fd, cmd, len);
  i = 0;
  do
  {
    n = read(fd, buf+i, 128-i);
    if(!n) break;
    i += n;
  }
  while((i < 6) || strncmp(buf+i-6, "\r\nOK\r\n", 6));
  
  if(!n) return 0;
  return i;
}

static int cid_TDK_read_tone(int fd, int mezzisecondi, void *null)
{
  unsigned char buf[128];
  int n, s, v, val;
  
  mezzisecondi *= 15;
  
  s = v = val = 0;
  
  for(; mezzisecondi; mezzisecondi--)
  {
    n = cid_TDK_send_recv(fd, "A/", 2, buf);
    if(n)
    {
      sscanf(buf+4, "%d", &v);
//      printf("%d %02x\n", mezzisecondi, v);
      
      if(!v && s)
        break;
      else if(v && !s)
      {
        if((v == 0x02) || (v == 0x08) || (v & 0x80))
        {
          s++;
          val = v;
        }
      }
    }
  }
  
  if(val & 0x80)
    v = 0x400;
  else if(val & 0x08)
    v = 0x200;
  else if(val & 0x02)
    v = 0x100;
  else
    v = 0;
  
//#warning
//printf("\n%04x\n", v);  
  return v;
}

static int cid_TDK_free_busy(int fd, void *null)
{
  int n;
  
  n = cid_TDK_read_tone(fd, 2, NULL);
  if(n)
  {
    support_log("CID: linea occupata.");
    return 1;
  }
  
  support_log("CID: linea libera.");
  return 0;
}

static void cid_TDK_init(int fd)
{
  char buf[64];
  
  cid_TDK_send_recv(fd, "ATS99=39S20=34S73=0X3\r", 22, buf);
  usleep(200000);
  cid_TDK_send_recv(fd, "ATS6=2\r", 7, buf);
}

static void cid_TDK_call(int fd, char *number)
{
  char buf[64];
  
  ser_setspeed(fd, B9600, 80);
  
  sprintf(buf, "ATDT%s;\r", number);
  cid_TDK_send_recv(fd, buf, strlen(buf), buf);
  
  ser_setspeed(fd, B9600, 5);
  
  /* Configurazione tono 1400Hz (freq 2) */
  usleep(50000);
  cid_TDK_send_recv(fd, "AT@A2.$EA=$2B.$C7\r", 18, buf);	// 1400
//  cid_TDK_send_recv(fd, "AT@A2.$EA=$3F.$20\r", 18, buf);	// 1209
//  cid_TDK_send_recv(fd, "AT@A2.$EA=$69.$0B\r", 18, buf);	// 697
//  cid_TDK_send_recv(fd, "AT@A2.$EA=$74.$EF\r", 18, buf);
  
  /* Configurazione tono 2300Hz (freq 4) */
  usleep(50000);
  cid_TDK_send_recv(fd, "AT@A2.$F2=$C8.$E8\r", 18, buf);	// 2300
//  cid_TDK_send_recv(fd, "AT@A2.$F2=$32.$6C\r", 18, buf);	// 1336
  
  /* Impostando a 1 il valore di attesa per il blind dial,
     a connessione avvenuta il comando di dial viene
     eseguito immediatamente. */
  cid_TDK_send_recv(fd, "ATS6=1\r", 7, buf);
  cid_TDK_send_recv(fd, "ATS63?\r", 7, buf);
}

static const char cid_to_key[] = {'0','1','2','3','4','5','6','7','8','9','0','*','#','A','B','C'};

static void cid_TDK_send(int fd, unsigned char *code)
{
  int i;
  char buf[128];
  
  support_log("ContactID: trasmissione messaggio.");
  sprintf(buf, "ATDT0000000000000000;\r");
  for(i=0; i<16; i++) buf[4+i] = cid_to_key[code[i]];
  
  ser_setspeed(fd, B9600, 50);
  cid_TDK_send_recv(fd, buf, 22, buf);
  ser_setspeed(fd, B9600, 5);
  
  /* Configurazione tono 1400Hz (freq 2) */
  usleep(50000);
  cid_TDK_send_recv(fd, "AT@A2.$EA=$2B.$C7\r", 18, buf);	// 1400
//  cid_TDK_send_recv(fd, "AT@A2.$EA=$3F.$20\r", 18, buf);	// 1209
  
  cid_TDK_send_recv(fd, "ATS63?\r", 7, buf);
}

static void cid_TDK_hangup(int fd)
{
  char buf[64];
  
  support_log("ContactID: hangup.");
  cid_TDK_send_recv(fd, "ATH0\r", 5, buf);
  usleep(200000);
  cid_TDK_send_recv(fd, "ATS6=2\r", 7, buf);
  sleep(1);
}

/****************************************
    Verifica modem
****************************************/

static const Modem Modem_SiLab = {
	.init = cid_SiLab_init,
	.call = cid_SiLab_call,
	.hangup = cid_SiLab_hangup,
	.read_tone = cid_SiLab_read_tone,
	.free_busy = cid_SiLab_free_busy,
	.send = cid_SiLab_send,
};

static const Modem Modem_USRobotics = {
	.init = cid_USR_init,
	.call = cid_USR_call,
	.hangup = cid_USR_hangup,
	.read_tone = cid_USR_read_tone,
	.free_busy = cid_USR_free_busy,
	.send = cid_USR_send,
};

static const Modem Modem_TDK = {
	.init = cid_TDK_init,
	.call = cid_TDK_call,
	.hangup = cid_TDK_hangup,
	.read_tone = cid_TDK_read_tone,
	.free_busy = cid_TDK_free_busy,
	.send = cid_TDK_send,
};

static const Modem* cid_probe_modem(int fd)
{
  char buf[128], *p;
  
  p = cid_send_recv(fd, "ATI\r", buf);
  if(!p[0])
  {
    ser_setspeed(fd, B115200|CRTSCTS|PARENB|PARODD, 5);
    write(fd, "\r", 1);
    ser_setspeed(fd, B115200|CRTSCTS, 5);
    p = cid_send_recv(fd, "ATI\r", buf);
  }
  
  /* Verifica modem US Robotics, voice modem */
  if(p[0] && strstr(p, "5601"))
  {
    p = cid_send_recv(fd, "AT+FCLASS=?\r", buf);
    if(p[0] && strstr(p, "8"))
    {
      support_log("ContactID: modem USRobotics.");
      return &Modem_USRobotics;
    }
    else
      return NULL;
  }
  
  if(!p[0])
  {
    ser_setspeed(fd, B115200|CRTSCTS|PARENB|PARODD, 5);
    write(fd, "\r", 1);
    p = cid_send_recv(fd, "ATI\r", buf);
  }
  
  /* Verifica modem SiLab, revision diversa da H */
  if(p[0] && !strstr(p, "H"))
  {
    p = cid_send_recv(fd, "ATI6\r", buf);
    if(p[0] && (strstr(p, "2456") || strstr(p, "2433") || strstr(p, "2414")))
    {
      support_log("ContactID: modem SiLab.");
      return &Modem_SiLab;
    }
  }
  
  ser_setspeed(fd, B9600, 5);
  cid_send_recv(fd, "AT\r", buf);
  p = cid_send_recv(fd, "ATI4\r", buf);
  if(p[0] && strstr(p, "TDK 73M2901"))
  {
    support_log("ContactID: modem TDK.");
    return &Modem_TDK;
  }
  
  return NULL;
}

/****************************************
    Main
****************************************/

static void cid_loop(ProtDevice *dev)
{
  unsigned char buf[128], ev[16];
  struct termios tio;
  int tono, seqnum, stato, tentativo, ciclo, squilli, num;
  const Modem *modem;
  IMA ima;
  void *data;
  
  tcgetattr(dev->fd, &tio);
  tio.c_cc[VTIME] = 5;
  tio.c_cc[VMIN] = 0;
  tcsetattr(dev->fd, TCSANOW, &tio);
  
  cid_send_recv(dev->fd, "AT\r", buf);
  
  modem = cid_probe_modem(dev->fd);
  if(!modem)
  {
    support_log("ContactID: modem non valido.");
    CID_set_error(3);
    return;
  }
  
  modem->init(dev->fd);
  /* si può migliorare... */
  data = &ima;
  
  support_log("ContactID: avvio.");
  
  stato = 0;
  tentativo = 0;
  seqnum = 0;
  ciclo = 0;
  squilli = 0;
  num = 0;
  
  while(1)
  {
#ifdef DEBUG
if(stato) printf("stato %d\n", stato);
#endif
    switch(stato)
    {
      case 0:	// riposo
        num = CID_get_message(ev);
        if(num)
        {
          tentativo = 1;
          ciclo = 1;
          stato = 1;
          seqnum = 0;
        }
        else
        {
          usleep(100000);
        }
        break;
      case 1:	// composizione
#ifdef DEBUG
printf("CID: stato 1\n");
#endif
        /* 151008 */
        if(!config.PhoneBook[num-1+seqnum].Phone[0])
        {
          switch(seqnum)
          {
            case 0:
              /* Questo deve essere sempre definito. */
              CID_set_error(1);
              stato = 0;
              continue;
              break;
            case 1:
              /* E' definito solo il numero primario.
                 Continuo ad usare quello. */
              seqnum = 0;
              break;
            case 2:
              /* Questo deve essere sempre definito se si vuole
                 utilizzare un secondo centro. */
              seqnum = 0;
              break;
            case 3:
              /* E' definito solo il numero primario del secondo centro.
                 Continuo ad usare quello. */
              seqnum = 2;
              break;
          }
        }
        sprintf(buf, "ContactID: chiamata al numero %d", num+seqnum);
        support_log(buf);
        modem->call(dev->fd, config.PhoneBook[num-1+seqnum].Phone);
        
        /* l'inizializzazione IMA serve solo per l'USR,
           ma non è un problema farla sempre. */
        ima_init(&ima);
        
        squilli = 0;
        stato = 2;
        break;
      case 2:	// sincronismo 1400Hz
#ifdef DEBUG
printf("CID: stato 2\n");
#endif
        if((tono = modem->read_tone(dev->fd, 30, data)) == 0x100)
          stato = 3;
        else
        {
#ifdef DEBUG
printf("tono = %04x\n", tono);
#endif
          if(tono == 0x200)
          {
            /* Ho ricevuto prima il tono a 2300HZ, quindi riprovo ad aspettare il 1400Hz */
            tentativo++;
            if(tentativo < 3) continue;
            /* Non è arrivato il tono a 1400Hz, continuo con il numero successivo */
            seqnum ^= 0x01;
            tentativo = 1;
            stato = 1;
            ciclo++;
          }
          else if(tono >= 0x400)
          {
            /* toni libero/occupato */
            tentativo = 1;
            squilli++;
            if(squilli < 4) continue;
            
            /* Ho ricevuto libero/occupato */
            switch(modem->free_busy(dev->fd, data))
            {
              case 0:	// libero
                support_log("ContactID: linea libera.");
                seqnum ^= 0x02;
                seqnum &= 0x02;
                tentativo = 1;
                stato = 1;
                ciclo++;
                break;
              case 1:	// occupato
                support_log("ContactID: linea occupata.");
                seqnum ^= 0x01;
                tentativo = 1;
                stato = 1;
                ciclo++;
                break;
            }
          }
          else if(tono)
          {
            /* Toni diversi */
            tentativo++;
            if(tentativo < 3) continue;
            stato = 1;
            ciclo++;
          }
          else
          {
            /* Timeout */
            stato = 1;
            ciclo++;
          }
          
          modem->hangup(dev->fd);
          if(ciclo > 8)
          {
            CID_set_error(2);
            stato = 0;
          }
        }
        break;
      case 3:	// sincronismo 2300Hz
#ifdef DEBUG
printf("CID: stato 3\n");
#endif
        if((tono = modem->read_tone(dev->fd, 1, data)) == 0x200)
        {
          tentativo = 1;
          stato = 4;
        }
        else
        {
#ifdef DEBUG
printf("tono = %04x\n", tono);
#endif
          modem->hangup(dev->fd);
          stato = 0;
        }
        break;
      case 4:	// invio segnalazione
#ifdef DEBUG
printf("CID: stato 4\n");
#endif
        modem->send(dev->fd, ev);
        ima_init(&ima);
        stato = 5;
        break;
      case 5:	// ricezione ok (1400Hz)
#ifdef DEBUG
printf("CID: stato 5\n");
#endif
        if((tono = modem->read_tone(dev->fd, 6, data)) == 0x100)
        {
#ifdef DEBUG
printf("CID: invio OK\n");
#endif
          support_log("ContactID: invio messaggio OK.");
          tentativo = 1;
          num = CID_get_message(ev);
          if(num) stato = 4;
          
          if(stato != 4)
          {
            modem->hangup(dev->fd);
            stato = 0;
          }
        }
        else
        {
#ifdef DEBUG
printf("CID: invio ERR (tono = %04x)\n", tono);
#endif
          support_log("ContactID: errore trasmissione.");
          tentativo++;
          if(tentativo > 3)
          {
            modem->hangup(dev->fd);
            stato = 0;
          }
          else
            stato = 4;
        }
        break;
    }
  }
}

void _init()
{
  printf("ContactID (plugin): " __DATE__ " " __TIME__ "\n");
  prot_plugin_register("CID", 0, NULL, NULL, (PthreadFunction)cid_loop);
}

